<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Jadwal Pelatihan</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="theme-color" content="#fda085">
  <style>
    body {
      background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
      min-height: 100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    
    .btn-back {
      background: linear-gradient(90deg, #f76b1c 60%, #fda085 100%);
      color: #fff;
      margin-top: 18px;
      padding: 10px 36px;
    }
    .btn-back:hover {
      background: linear-gradient(90deg, #fda085 0%, #f76b1c 100%);
      color: #fff;
    }

    .container-card {
      max-width: 1200px;
      margin: 10px auto;
      padding: 28px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      position: relative;
      overflow: hidden;
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }
    
    .avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fda085 60%, #f6d365 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: #fff;
      margin-right: 12px;
      box-shadow: 0 2px 8px rgba(253,160,133,0.18);
    }
    
    .dashboard-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #f76b1c;
      letter-spacing: 1px;
    }
    
    .admin-desc, .text-muted { color: #666; }

    /* View toggle tabs */
    .view-toggle {
      margin-bottom: 20px;
    }
    
    .view-toggle .nav-link {
      color: #f76b1c;
      border-color: #fda085;
      font-weight: 500;
      margin-right: 10px;
      padding: 5px 20px;
      margin-bottom: 5px;
    }
    
    .view-toggle .nav-link.active {
      background-color: #f76b1c;
      border-color: #f76b1c;
      color: white;
    }

    /* Form input styling */
    .inputs-row { 
      display: flex; 
      gap: 0.5rem; 
      align-items: center; 
      flex-wrap: wrap; 
      padding-bottom: 0.5rem; 
    }
    
    .form-input { 
      min-width: 140px; 
      flex: 1; 
    }
    
    .form-row { gap:12px; display:flex; flex-wrap:wrap; margin-bottom:8px; }
    .form-row > * { flex:1 1 200px; }
    
    .form-select {
      border: 1px solid #ced4da;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.95rem;
      background-color: #fff;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-select:focus {
      border-color: #fda085;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(253, 160, 133, 0.25);
    }
    
    @media (max-width: 768px) {
      .inputs-row {
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .form-input {
        width: 100%;
        min-width: unset;
      }
    }

    /* Sidebar styling */
    .offcanvas {
      background: #fff8f3;
      border-top-right-radius: 18px;
      border-bottom-right-radius: 18px;
      box-shadow: 2px 0 16px rgba(253,160,133,0.08);
    }
    .offcanvas-title {
      color: #f76b1c;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .nav-link {
      font-weight: 500;
      color: #f76b1c;
      border-radius: 8px;
    }
    .nav-link:hover, .nav-link.active {
      background: linear-gradient(90deg, #fda08522 0%, #f6d36522 100%);
      color: #f76b1c;
    }

    /* Table styling */
    .activity-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-bottom: 20px;
      border: 2px solid #000;
      table-layout: auto;
      position: relative;
    }
    
    .activity-table th,
    .activity-table td {
      border: 1px solid #000;
      padding: 8px 4px;
      text-align: center;
      vertical-align: middle;
      font-size: 11px;
      word-wrap: break-word;
    }
    
    .activity-table th {
      background-color: #f8f9fa;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    
    /* Day row styling */
    .activity-table tr#dayRow th {
      background-color: transparent;
      font-weight: normal;
      font-size: 9px;
      padding: 2px 4px;
      position: sticky;
      top: 28px; /* Below the main header */
      z-index: 19;
      border-bottom: 1px solid #000 !important; /* Ensure bottom border is visible */
    }
    
    /* Freeze pane styling for No and Kegiatan columns */
    .activity-table th.no-col,
    .activity-table td.no-col {
      position: sticky;
      left: 0;
      background-color: #f8f9fa !important;
      z-index: 15;
      border-right: 2px solid #000 !important;
    }
    
    .activity-table th.activity-col,
    .activity-table td.activity-col {
      position: sticky;
      left: 60px; /* Width of No column */
      background-color: #fff !important;
      z-index: 15;
      border-right: 2px solid #000 !important;
    }
    
    /* Higher z-index for header cells in frozen columns */
    .activity-table th.no-col {
      z-index: 25;
    }
    
    .activity-table th.activity-col {
      z-index: 25;
      background-color: #f8f9fa !important;
    }
    
    /* Day row freeze pane styling */
    .activity-table tr#dayRow th.no-col {
      background-color: transparent !important;
      z-index: 24;
    }
    
    .activity-table tr#dayRow th.activity-col {
      background-color: transparent !important;
      z-index: 24;
    }
    
    .activity-table tbody tr:hover {
      background-color: #f5f5f5;
    }
    
    /* Ensure frozen columns maintain their background on hover */
    .activity-table tbody tr:hover td.no-col {
      background-color: #f8f9fa !important;
    }
    
    .activity-table tbody tr:hover td.activity-col {
      background-color: #fff !important;
    }
    
    /* Column widths */
    .no-col { 
      width: 60px; 
      min-width: 60px; 
    }
    
    .activity-col { 
      width: 250px; 
      min-width: 200px;
      text-align: left !important;
      padding-left: 8px !important;
    }
    
    .date-col { 
      width: 50px; 
      min-width: 40px;
      text-align: center !important;
      padding: 4px 2px !important;
      font-size: 10px !important;
      white-space: nowrap;
    }
    
    /* Date column specific styling */
    .date-col {
      background-color: #f8f9fa;
      border-left: 1px solid #dee2e6;
      border-right: 1px solid #dee2e6;
    }
    
    .activity-table td.date-col {
      background-color: #fff;
      font-size: 12px;
      font-weight: bold;
    }

    /* Activity duration color coding */
    .activity-duration-1 { background-color: #f44336 !important; color: white !important; } /* Red */
    .activity-duration-2 { background-color: #e91e63 !important; color: white !important; } /* Pink */
    .activity-duration-3 { background-color: #9c27b0 !important; color: white !important; } /* Purple */
    .activity-duration-4 { background-color: #673ab7 !important; color: white !important; } /* Deep Purple */
    .activity-duration-5 { background-color: #3f51b5 !important; color: white !important; } /* Indigo */
    .activity-duration-6 { background-color: #2196f3 !important; color: white !important; } /* Blue */
    .activity-duration-7 { background-color: #00bcd4 !important; color: white !important; } /* Cyan */
    .activity-duration-8 { background-color: #4caf50 !important; color: white !important; } /* Green */
    .activity-duration-9 { background-color: #8bc34a !important; color: white !important; } /* Light Green */
    .activity-duration-10 { background-color: #ffeb3b !important; color: black !important; } /* Yellow */
    
    /* Default colors for longer durations */
    .activity-duration-long { background-color: #607d8b !important; color: white !important; } /* Blue Gray */


    /* Input styling dalam tabel */
    .table-input {
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
      padding: 2px 4px;
      font-size: 11px;
    }
    
    .activity-input {
      text-align: left;
    }

    /* Timeline Styles */
    .timeline-container {
      margin-bottom: 30px;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .timeline-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #f76b1c;
      margin: 0;
    }

    .timeline-view-toggle {
      display: flex;
      gap: 5px;
    }

    .timeline-view-toggle .btn {
      font-size: 0.85rem;
      padding: 5px 12px;
    }

    .timeline-filter-bar {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .timeline-filter-bar .form-label {
      white-space: nowrap;
      font-weight: 500;
      color: #666;
    }

    .timeline-filter-bar .form-select {
      font-size: 0.9rem;
      padding: 6px 12px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
    }

    .timeline {
      position: relative;
      padding-left: 30px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, #fda085, #f6d365);
    }

    .timeline-item {
      position: relative;
      margin-bottom: 25px;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-left: 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .timeline-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -32px;
      top: 20px;
      width: 14px;
      height: 14px;
      background: #fda085;
      border-radius: 50%;
      border: 3px solid #fff;
      box-shadow: 0 0 0 2px #fda085;
    }

    .timeline-content {
      position: relative;
    }

    .timeline-date {
      position: absolute;
      top: -8px;
      right: 0;
      background: linear-gradient(45deg, #fda085, #f6d365);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .timeline-title-item {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .timeline-subtitle {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .timeline-duration {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }

    .duration-badge {
      background: #e9ecef;
      color: #495057;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .timeline-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }

    .timeline-actions .btn {
      padding: 4px 10px;
      font-size: 0.8rem;
    }

    .timeline-empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    /* Responsive design */
    @media (max-width: 900px) {
      .container-card {
        padding: 18px 6px 16px 6px;
        max-width: 90vw;
      }
      .dashboard-header {
        flex-direction: column;
        gap: 8px;
        align-items: center;
        justify-content: center;
      }
      .dashboard-title {
        text-align: center;
        width: 100%;
      }
      .avatar {
        margin-right: 0;
        margin-bottom: 6px;
      }
      .offcanvas.offcanvas-start{
        width: 82%;
        max-width: 360px;
        left: 0;
        top: 0;
        height: 100%;
        box-shadow: 2px 8px 40px rgba(0,0,0,0.12);
        border-top-right-radius: 18px;
        border-bottom-right-radius: 18px;
        font-size: 1.4rem;
      }
    }
    
    @media (max-width: 768px) {
      .activity-table {
        font-size: 10px;
      }
      
      .activity-table th,
      .activity-table td {
        padding: 4px 2px;
      }
      
      .no-col { width: 40px; min-width: 40px; }
      .activity-col { width: 150px; min-width: 120px; }
      .date-col { width: 80px; min-width: 70px; }
    }

    /* Horizontal scroll container */
    .table-container {
      overflow-x: auto;
      max-width: 100%;
    }

    /* Loading spinner */
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    /* View containers */
    .view-content {
      display: none;
    }
    
    .view-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Menu button -->
  <button class="btn btn-outline-secondary mb-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">‚ò∞ Menu</button>

  <!-- Sidebar -->
  <nav class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">üìö Buku Saku</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body px-2">
      <ul class="nav flex-column">
        <li class="nav-item mb-2"><a class="nav-link" href="dashboard.html">üè† Dashboard</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="prosedur2.html">üìë Prosedur</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="rostercuti2.html">üóìÔ∏è Roster Cuti</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="administrasi.html">üóÇÔ∏è Administrasi</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="preposttest.html">üìù Pre/Post Test</a></li>
        <li class="nav-item mb-2"><a class="nav-link active" href="timeframe.html">üïí Jadwal Pelatihan</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="progress-table.html">‚è∞ Update HM</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="daily.html">üìò Daily Activity</a></li>
        <li class="nav-item mt-4"><a class="nav-link text-danger" href="login.html">üö™ Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="container container-card">
    <div class="dashboard-header">
      <div class="avatar">üïí</div>
      <div class="dashboard-title">Jadwal Pelatihan</div>
    </div>
    
    <div class="mb-2">
      <p class="admin-desc mb-0">Buat jadwal pelatihan dan Timeframe. Data tersimpan ke spreadsheets.</p>
    </div>

    <!-- View Toggle -->
    <ul class="nav nav-tabs view-toggle" id="viewTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-view" type="button" role="tab">
          Timeline View
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-view" type="button" role="tab">
          Table View
        </button>
      </li>
    </ul>

    <div class="tab-content" id="viewTabsContent">
      <!-- Timeline View -->
      <div class="tab-pane fade show active view-content" id="timeline-view" role="tabpanel">
        <!-- Form input untuk Timeline -->
        <form id="timelineForm" class="mb-3" autocomplete="off">
          <div class="form-row">
            <select name="jenisPelatihan" class="form-select" onchange="updateNamaPelatihan(this.value); updateKegiatanOptions(this.value)">
              <option value="">-- Pilih Jenis Pelatihan --</option>
              <option value="OPP HDT">OPP HDT</option>
              <option value="OCD HDT INTERNAL">OCD HDT INTERNAL</option>
              <option value="OCD HDT EKSTERNAL">OCD HDT EKSTERNAL</option>
              <option value="OSO HDT INTERNAL">OSO HDT INTERNAL</option>
              <option value="OSO HDT EKSTERNAL">OSO HDT EKSTERNAL</option>
              <option value="ORP HDT">ORP HDT</option>
            </select>
            <input required name="paket" class="form-control" placeholder="Nama Pelatihan (misal: OPP Batch 20)">
          </div>
          <div class="form-row">
            <select required name="kegiatan" class="form-select" id="kegiatanSelect">
              <option value="">-- Pilih Jenis Pelatihan Dahulu --</option>
            </select>
          </div>
          <div class="form-row">
            <input required type="text" name="mulai" class="form-control" placeholder="Tanggal mulai (DD-MM-YYYY)"
                   onfocus="this.type='date'" onblur="if(!this.value) this.type='text'">
            <input required type="text" name="selesai" class="form-control" placeholder="Tanggal selesai (DD-MM-YYYY)"
                   onfocus="this.type='date'" onblur="if(!this.value) this.type='text'">
          </div>
          <div class="d-flex gap-2" style="margin-top:8px;">
            <button class="btn btn-primary" type="submit">Simpan</button>
            <button id="clearAllTimeline" type="button" class="btn btn-outline-secondary">Reset</button>
          </div>
        </form>

        <hr>

        <!-- Timeline Section -->
        <div class="timeline-container">
          <div class="timeline-header">
            <h5 class="timeline-title">üìÖ Timeline Pelatihan</h5>
            <div class="timeline-filter-bar">
              <label for="timelineFilter" class="form-label mb-0">Filter:</label>
              <select id="timelineFilter" class="form-select" style="width: 150px;" onchange="filterTimeline()">
                <option value="all">Semua</option>
                <option value="current">Saat Ini</option>
                <option value="upcoming">Mendatang</option>
                <option value="completed">Selesai</option>
              </select>
            </div>
          </div>
          <div id="timelineContent" class="timeline">
            <!-- Timeline items will be generated here -->
          </div>
        </div>
      </div>

      <!-- Table View -->
      <div class="tab-pane fade view-content" id="table-view" role="tabpanel">
        <!-- Filter Section -->
        <div class="d-flex justify-content-end mb-3">
          <div class="d-flex align-items-center gap-2">
            <label for="trainingFilter" class="form-label mb-0" style="white-space: nowrap;">Nama Pelatihan:</label>
            <select id="trainingFilter" class="form-select" style="width: 250px;" onchange="filterTableByTraining()">
              <option value="">-- Semua Pelatihan --</option>
            </select>
          </div>
        </div>

        <!-- Loading indicator -->
        <div id="loadingIndicator" class="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>Memuat data...</p>
        </div>

        <!-- No selection message -->
        <div id="noSelectionMessage" class="text-center p-5" style="display: none;">
          <div class="mb-3" style="font-size: 3rem;">üìã</div>
          <h4 class="mb-2">Pilih Pelatihan</h4>
          <p class="text-muted">Pilih pelatihan dari dropdown di atas untuk melihat timeframe pelatihan.</p>
        </div>

        <!-- Table container -->
        <div class="table-container" style="overflow-x: auto; max-width: 100%; border: 1px solid #dee2e6;">
          <table class="activity-table" id="activityTable">
            <thead>
              <tr id="headerRow">
                <!-- Headers will be generated dynamically -->
              </tr>
              <tr id="dayRow">
                <!-- Day names will be generated dynamically -->
              </tr>
            </thead>
            <tbody id="tableBody">
              <!-- Data akan ditampilkan di sini -->
            </tbody>
          </table>
        </div>

        <!-- Controls -->
        <div class="d-flex align-items-center gap-2 mt-2">
          <button id="btnRefresh" class="btn btn-outline-primary">üîÑ Refresh</button>
        </div>

        <!-- Color Legend -->
        <div class="mt-3">
          <small class="text-muted">
            <strong>üìä Keterangan Warna:</strong> Setiap kegiatan memiliki warna berbeda berdasarkan durasi hari. 
            Warna ditampilkan pada kolom tanggal sesuai periode kegiatan.
          </small>
        </div>
      </div>
    </div>

    <!-- Back button -->
    <div class="text-center">
      <a href="dashboard.html" class="btn btn-back">‚¨ÖÔ∏è Kembali ke Dashboard</a>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // API configuration
    const API_URL = "https://script.google.com/macros/s/AKfycbyCbEPQIcaKgBU-jQbmSeC_1R1tXh1Y3hA7d3q8VMCr46qtpm6lanKbrebZ-1OD2Q7h/exec";
    const KEY = 'bukuSakuTimeframes';

    // State management for both views
    let STATE = [];
    let TIMELINE_DATA = [];
    let COLUMNS = ['no', 'paket', 'kegiatan', 'tanggal_mulai', 'tanggal_selesai']; // Updated to match timeline data
    let isEditing = false;

    // ===== SHARED UTILITY FUNCTIONS =====
    
    // Helper function to send requests
    async function sendRequest(payload) {
      console.log("Sending request:", payload);
      
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
          mode: 'cors'
        });
        
        console.log("Response status:", res.status);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error("Response error:", errorText);
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const result = await res.json();
        console.log("Response data:", result);
        return result;
        
      } catch (error) {
        console.error("Request failed:", error);
        
        // Check if it's a network error
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          throw new Error('Koneksi ke server gagal. Periksa koneksi internet Anda.');
        }
        
        throw error;
      }
    }

    // Helper fetch for timeline (consistent with baruedit.html)
    async function apiFetch(jsonBody){
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(jsonBody)
        });
        try { return await res.json(); } catch(e){ return null; }
      } catch(e){
        console.warn('API request failed', e);
        return null;
      }
    }

    // Show/hide loading indicator
    function setLoading(show) {
      const loading = document.getElementById('loadingIndicator');
      const table = document.querySelector('.table-container');
      if (loading && table) {
        if (show) {
          loading.style.display = 'block';
          table.style.display = 'none';
        } else {
          loading.style.display = 'none';
          table.style.display = 'block';
        }
      }
    }

    // Success/Error/Info message functions
    function showSuccessMessage(message) {
      removeMessage();
      const messageDiv = document.createElement('div');
      messageDiv.id = 'statusMessage';
      messageDiv.className = 'alert alert-success alert-dismissible fade show';
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.right = '20px';
      messageDiv.style.zIndex = '9999';
      messageDiv.style.minWidth = '300px';
      messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="removeMessage()"></button>
      `;
      document.body.appendChild(messageDiv);
      setTimeout(removeMessage, 3000);
    }

    function showErrorMessage(message) {
      removeMessage();
      const messageDiv = document.createElement('div');
      messageDiv.id = 'statusMessage';
      messageDiv.className = 'alert alert-danger alert-dismissible fade show';
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.right = '20px';
      messageDiv.style.zIndex = '9999';
      messageDiv.style.minWidth = '300px';
      messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="removeMessage()"></button>
      `;
      document.body.appendChild(messageDiv);
      setTimeout(removeMessage, 5000);
    }

    function showInfoMessage(message) {
      removeMessage();
      const messageDiv = document.createElement('div');
      messageDiv.id = 'statusMessage';
      messageDiv.className = 'alert alert-info alert-dismissible fade show';
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.right = '20px';
      messageDiv.style.zIndex = '9999';
      messageDiv.style.minWidth = '300px';
      messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="removeMessage()"></button>
      `;
      document.body.appendChild(messageDiv);
      setTimeout(removeMessage, 4000);
    }

    function removeMessage() {
      const existing = document.getElementById('statusMessage');
      if (existing) {
        existing.remove();
      }
    }

    // ===== TABLE VIEW FUNCTIONS =====

    // API functions for table
    async function loadData() {
      try {
        const response = await sendRequest({ target: "activity_table", action: "read" });
        return response;
      } catch (error) {
        console.log("Trying generic read...");
        return sendRequest({ action: "read" });
      }
    }

    async function addData(params) {
      try {
        return await sendRequest({ target: "activity_table", action: "add", ...params });
      } catch (error) {
        return sendRequest({ action: "add", data: params });
      }
    }

    async function editData(params) {
      try {
        return await sendRequest({ target: "activity_table", action: "edit", ...params });
      } catch (error) {
        return sendRequest({ action: "edit", data: params });
      }
    }

    async function deleteData(row) {
      try {
        return await sendRequest({ target: "activity_table", action: "delete", row });
      } catch (error) {
        return sendRequest({ action: "delete", row: row });
      }
    }

    // Get next auto-increment number
    function getNextNumber() {
      if (STATE.length === 0) return 1;
      
      const numbers = STATE.map(row => {
        const no = parseInt(row.no);
        return isNaN(no) ? 0 : no;
      });
      
      const maxNumber = Math.max(...numbers);
      return maxNumber + 1;
    }

    // Add row to table immediately without full reload
    function addRowToTable(newData, rowIndex) {
      const tbody = document.getElementById('tableBody');
      const tr = document.createElement('tr');
      
      tr.style.backgroundColor = '#e8f5e8';
      setTimeout(() => {
        tr.style.backgroundColor = '';
        tr.style.transition = 'background-color 0.5s ease';
      }, 100);
      
      COLUMNS.forEach(col => {
        const td = document.createElement('td');
        td.className = getColumnClass(col);
        
        if (col === 'activity') {
          td.style.textAlign = 'left';
          td.style.paddingLeft = '8px';
        }
        
        td.textContent = formatCellValue(col, newData[col]);
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    }

    // Update table dynamically when columns are added
    function updateTableColumns() {
      renderHeader();
      
      const tbody = document.getElementById('tableBody');
      const existingRows = tbody.querySelectorAll('tr');
      
      existingRows.forEach((row, idx) => {
        const data = STATE[idx];
        if (!data) return;
        
        row.innerHTML = '';
        
        COLUMNS.forEach(col => {
          const td = document.createElement('td');
          td.className = getColumnClass(col);
          
          if (col === 'activity') {
            td.style.textAlign = 'left';
            td.style.paddingLeft = '8px';
          }
          
          td.textContent = formatCellValue(col, data[col] || '');
          row.appendChild(td);
        });
      });
    }

    // Load and render data for table (using timeline data)
    async function reload() {
      try {
        setLoading(true);
        console.log("Loading timeline data for table view from:", API_URL);
        
        // Load timeline data for table display
        TIMELINE_DATA = await loadTimeline();
        
        // Start with empty STATE - show no selection message initially
        STATE = [];
        
        // Generate empty date columns initially
        generateDateColumns();
        
        console.log("Timeline data loaded:", TIMELINE_DATA.length, "items");

        renderTable();
        
        // Populate training filter dropdown
        populateTrainingFilter();
        
        // Show no selection message initially
        const noSelectionMessage = document.getElementById('noSelectionMessage');
        const tableContainer = document.querySelector('.table-container');
        const controlsDiv = document.querySelector('.d-flex.align-items-center.gap-2.mt-2');
        const colorLegend = document.querySelector('.mt-3');
        
        if (noSelectionMessage) noSelectionMessage.style.display = 'block';
        if (tableContainer) tableContainer.style.display = 'none';
        if (controlsDiv) controlsDiv.style.display = 'none';
        if (colorLegend) colorLegend.style.display = 'none';
        
        if (TIMELINE_DATA.length === 0) {
          showInfoMessage("Tidak ada data timeline ditemukan. Tambahkan data di Timeline View untuk melihatnya di tabel.");
        }
        
      } catch (err) {
        console.error("Load error:", err);
        showErrorMessage("Gagal memuat data timeline. Periksa koneksi internet Anda.");
        
        STATE = [];
        renderTable();
      } finally {
        setLoading(false);
      }
    }

    // Render table header
    function renderHeader() {
      const headerRow = document.getElementById('headerRow');
      const dayRow = document.getElementById('dayRow');
      if (!headerRow || !dayRow) return;
      
      headerRow.innerHTML = '';
      dayRow.innerHTML = '';

      // Day names in Indonesian (3 letters)
      const dayNames = ['MIN', 'SEN', 'SEL', 'RAB', 'KAM', 'JUM', 'SAB'];

      COLUMNS.forEach(col => {
        const th = document.createElement('th');
        
        // Check if this is a date column (YYYY-MM-DD format)
        if (col.match(/^\d{4}-\d{2}-\d{2}$/)) {
          const date = new Date(col);
          const day = date.getDate().toString().padStart(2, '0');
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          th.textContent = `${day}/${month}`;
          th.className = 'date-col';
          th.style.minWidth = '50px';
          th.style.fontSize = '10px';
          th.style.padding = '4px 2px';
          
          // Add corresponding day cell for date columns
          const dayTh = document.createElement('th');
          const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
          dayTh.textContent = dayNames[dayOfWeek];
          dayTh.className = 'date-col';
          dayTh.style.minWidth = '50px';
          dayTh.style.fontSize = '9px';
          dayTh.style.padding = '2px 4px';
          dayRow.appendChild(dayTh);
        } else {
          // For No and Kegiatan columns, merge with row below using rowspan
          th.textContent = formatColumnName(col);
          th.className = getColumnClass(col);
          th.rowSpan = 2; // Merge with the row below
          th.style.verticalAlign = 'middle'; // Center the text vertically
          th.style.textAlign = 'center'; // Center the text horizontally for headers
          // Don't add to dayRow - it's merged
        }
        
        headerRow.appendChild(th);
      });
    }

    // Format column name for display
    function formatColumnName(col) {
      const nameMap = {
        'no': 'NO',
        'paket': 'NAMA PELATIHAN',
        'kegiatan': 'KEGIATAN',
        'activity': 'AKTIVITAS',
        'aktivitas': 'AKTIVITAS',
        'nama': 'KEGIATAN',
        'tanggal_mulai': 'TANGGAL MULAI',
        'tanggal_selesai': 'TANGGAL SELESAI',
        'tanggal_akhir': 'TANGGAL AKHIR',
        'mulai': 'TANGGAL MULAI',
        'selesai': 'TANGGAL SELESAI',
        'start_date': 'TANGGAL MULAI',
        'end_date': 'TANGGAL AKHIR',
        'date': 'TANGGAL',
        'description': 'DESKRIPSI',
        'progress': 'PROGRESS',
        'pic': 'PIC',
        'responsible': 'PENANGGUNG JAWAB'
      };
      
      const lowerCol = col.toLowerCase();
      return nameMap[lowerCol] || col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()).toUpperCase();
    }

    // Get CSS class for column
    function getColumnClass(col) {
      const classMap = {
        'no': 'no-col',
        'kegiatan': 'activity-col',
        'activity': 'activity-col',
        'paket': 'activity-col'
      };
      return classMap[col] || 'date-col';
    }

    // Format cell value for display
    function formatCellValue(col, value) {
      if (!value) return '';
      
      const lowerCol = col.toLowerCase();
      
      // Handle date column values (checkmarks, current, future indicators)
      if (col.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return value; // Return as is (‚úì, üîÑ, ‚è≥, or empty)
      }
      
      if (lowerCol.includes('tanggal') || lowerCol.includes('date') || 
          ['tanggal_mulai', 'tanggal_selesai', 'tanggal_akhir', 'mulai', 'selesai', 'start_date', 'end_date'].includes(lowerCol)) {
        
        let date;
        if (typeof value === 'string') {
          if (value.includes('/')) {
            date = new Date(value);
          } else if (value.includes('-')) {
            date = new Date(value);
          } else {
            date = new Date(value);
          }
        } else {
          date = new Date(value);
        }
        
        if (!isNaN(date.getTime())) {
          return date.toLocaleDateString('id-ID');
        }
      }
      
      return String(value);
    }

    // Render table body
    function renderTable() {
      renderHeader();
      
      const tbody = document.getElementById('tableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '';

      STATE.forEach((row, idx) => {
        const tr = document.createElement('tr');
        
        COLUMNS.forEach(col => {
          const td = document.createElement('td');
          td.className = getColumnClass(col);
          
          if (col === 'kegiatan') {
            td.style.textAlign = 'left';
            td.style.paddingLeft = '8px';
          }
          
          // Apply color coding to date columns within activity period
          if (col.match(/^\d{4}-\d{2}-\d{2}$/) && row[col]) {
            // This is a date column with activity data
            td.classList.add(row.colorClass || 'activity-duration-long');
          }
          
          td.textContent = formatCellValue(col, row[col]);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    // Populate training filter dropdown
    function populateTrainingFilter() {
      const filterSelect = document.getElementById('trainingFilter');
      if (!filterSelect) return;
      
      // Get unique training names from timeline data
      const uniqueTrainings = [...new Set(TIMELINE_DATA.map(item => item.paket).filter(paket => paket))];
      
      // Clear existing options except the first one
      filterSelect.innerHTML = '<option value="">-- Semua Pelatihan --</option>';
      
      // Add options for each unique training
      uniqueTrainings.sort().forEach(training => {
        const option = document.createElement('option');
        option.value = training;
        option.textContent = training;
        filterSelect.appendChild(option);
      });
    }

    // Filter table by selected training
    function filterTableByTraining() {
      const filterSelect = document.getElementById('trainingFilter');
      const selectedTraining = filterSelect.value;
      const noSelectionMessage = document.getElementById('noSelectionMessage');
      const tableContainer = document.querySelector('.table-container');
      const controlsDiv = document.querySelector('.d-flex.align-items-center.gap-2.mt-2');
      const colorLegend = document.querySelector('.mt-3');
      
      if (!selectedTraining) {
        // Show no selection message and hide table
        noSelectionMessage.style.display = 'block';
        tableContainer.style.display = 'none';
        if (controlsDiv) controlsDiv.style.display = 'none';
        if (colorLegend) colorLegend.style.display = 'none';
        STATE = [];
      } else {
        // Hide no selection message and show table
        noSelectionMessage.style.display = 'none';
        tableContainer.style.display = 'block';
        if (controlsDiv) controlsDiv.style.display = 'flex';
        if (colorLegend) colorLegend.style.display = 'block';
        
        // Filter by selected training
        const filteredData = TIMELINE_DATA.filter(item => item.paket === selectedTraining);
        STATE = filteredData.map((item, index) => ({
          no: index + 1,
          paket: item.paket || '',
          kegiatan: item.nama || '',
          tanggal_mulai: item.mulai || '',
          tanggal_selesai: item.selesai || '',
          row: item.row // Keep original row reference for editing
        }));
      }
      
      // Regenerate date columns and re-render table
      generateDateColumns();
      renderTable();
    }

    // Form submission for table (saves to timeline data)
    async function onSubmitForm(ev) {
      ev.preventDefault();
      const form = ev.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      const submitBtn = document.getElementById('btnSave');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Menyimpan...';

      try {
        // Convert table data to timeline format
        const timelineData = {
          paket: data.kegiatan, // Use kegiatan as paket since we removed the paket field
          nama: data.kegiatan, // kegiatan maps to nama in timeline
          mulai: data.tanggal_mulai,
          selesai: data.tanggal_selesai
        };

        if (data.row) {
          // Edit existing timeline item
          const ok = await editRemote(data.row, timelineData);
          if (!ok) {
            // Fallback to local storage
            const arr = await loadTimeline();
            const idx = arr.findIndex(x => x.row === parseInt(data.row));
            if (idx !== -1) {
              arr[idx] = { ...arr[idx], ...timelineData };
              saveLocal(arr);
            }
          }
          showSuccessMessage("Data berhasil diupdate!");
        } else {
          // Add new timeline item
          const ok = await addRemote(timelineData);
          if (!ok) {
            // Fallback to local storage
            const arr = await loadTimeline();
            arr.push({ ...timelineData, row: arr.length + 2 });
            saveLocal(arr);
          }
          showSuccessMessage("Data berhasil ditambahkan!");
        }

        resetForm();
        // Reload both table and timeline
        await reload();
        await renderTimeline();
        
      } catch (err) {
        console.error("Submit error:", err);
        showErrorMessage("Gagal menyimpan data!");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }

    // Edit data (from table view)
    function onEdit(tableRowIndex) {
      const data = STATE[tableRowIndex - 1]; // STATE is 0-indexed but display is 1-indexed
      if (!data) return;

      const form = document.getElementById('activityForm');
      
      // Fill form with timeline data (no paket field)
      form.querySelector('[name="kegiatan"]').value = data.kegiatan || '';
      
      if (data.tanggal_mulai) {
        const startDate = new Date(data.tanggal_mulai);
        if (!isNaN(startDate.getTime())) {
          form.querySelector('[name="tanggal_mulai"]').value = startDate.toISOString().split('T')[0];
        }
      }
      
      if (data.tanggal_selesai) {
        const endDate = new Date(data.tanggal_selesai);
        if (!isNaN(endDate.getTime())) {
          form.querySelector('[name="tanggal_selesai"]').value = endDate.toISOString().split('T')[0];
        }
      }

      document.getElementById('editingRow').value = data.row; // Use original timeline row
      document.getElementById('btnSave').textContent = 'Update';
      isEditing = true;
    }

    // Delete data (from table view)
    async function onDelete(tableRowIndex) {
      if (!confirm("Yakin ingin hapus data ini?")) return;
      
      try {
        const data = STATE[tableRowIndex - 1]; // STATE is 0-indexed
        if (!data || !data.row) return;
        
        // Delete from timeline
        const ok = await deleteRemote(data.row);
        if (!ok) {
          // Fallback to local storage
          const arr = (await loadTimeline()).filter(x => x.row !== data.row);
          saveLocal(arr);
        }
        
        // Reload both table and timeline
        await reload();
        await renderTimeline();
        
        showSuccessMessage("Data berhasil dihapus!");
      } catch (err) {
        console.error("Delete error:", err);
        showErrorMessage("Gagal menghapus data!");
      }
    }

    // Reset form
    function resetForm() {
      const form = document.getElementById('activityForm');
      if (form) {
        form.reset();
        document.getElementById('editingRow').value = '';
        document.getElementById('autoNo').value = '';
        document.getElementById('btnSave').textContent = 'Tambah';
        isEditing = false;
      }
    }

    // Add new column
    function addColumn() {
      const colName = prompt("Masukkan nama kolom baru:");
      if (!colName) return;
      
      const normalizedName = colName.toLowerCase().replace(/\s+/g, '_');
      if (COLUMNS.includes(normalizedName)) {
        alert("Kolom sudah ada!");
        return;
      }

      if (normalizedName === 'no') {
        alert("Kolom 'No' sudah ada dan otomatis!");
        return;
      }

      COLUMNS.push(normalizedName);
      
      const inputsRow = document.querySelector('.inputs-row');
      const newInput = document.createElement('input');
      newInput.name = normalizedName;
      newInput.type = 'text';
      newInput.className = 'form-control form-input';
      newInput.placeholder = colName;
      
      const hiddenInput = document.getElementById('editingRow');
      inputsRow.insertBefore(newInput, hiddenInput);
      
      updateTableColumns();
      showSuccessMessage(`Kolom '${colName}' berhasil ditambahkan!`);
      setTimeout(() => newInput.focus(), 100);
    }

    // ===== FORM DROPDOWN FUNCTIONS =====

    // Function to update nama pelatihan based on jenis pelatihan selection
    function updateNamaPelatihan(jenisPelatihan) {
      const namaInput = document.querySelector('input[name="paket"]');
      if (jenisPelatihan && namaInput) {
        // Auto-fill dengan format: [Jenis] Batch [nomor urut berdasarkan tanggal]
        const today = new Date();
        const year = today.getFullYear().toString().slice(-2); // Get last 2 digits of year
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const batchNumber = `${year}${month}`;
        
        namaInput.value = `${jenisPelatihan} Batch ${batchNumber}`;
        namaInput.focus();
      }
    }

    // Function to update kegiatan options based on jenis pelatihan
    function updateKegiatanOptions(jenisPelatihan) {
      const kegiatanSelect = document.getElementById('kegiatanSelect');
      if (!kegiatanSelect) return;
      
      // Clear existing options
      kegiatanSelect.innerHTML = '';
      
      if (!jenisPelatihan) {
        kegiatanSelect.innerHTML = '<option value="">-- Pilih Jenis Pelatihan Dahulu --</option>';
        return;
      }
      
      // Define kegiatan options for each jenis pelatihan
      const kegiatanOptions = {
        'OPP HDT': [
          'TEORI UMUM',
          'TEORI TEKNIS', 
          'SIMULATOR',
          'PENDAMPINGAN INSTRUKTUR',
          'PENDAMPINGAN OPERATOR',
          'EVALUASI PRAKTEK',
          'PRAKTEK MALAM',
          'DDT',
          'ORIENTASI UNIT LAIN'
        ],
        'OCD HDT INTERNAL': [
          'TEORI UMUM',
          'TEORI TEKNIS', 
          'SIMULATOR',
          'PENDAMPINGAN INSTRUKTUR',
          'PENDAMPINGAN OPERATOR',
          'TANPA PENDAMPINGAN',
          'PRAKTEK MALAM',
          'DDT',
          'ORIENTASI UNIT LAIN'
        ],
        'OCD HDT EKSTERNAL': [
          'TEORI UMUM',
          'TEORI TEKNIS', 
          'SIMULATOR',
          'PENDAMPINGAN INSTRUKTUR',
          'PENDAMPINGAN OPERATOR',
          'TANPA PENDAMPINGAN',
          'PRAKTEK MALAM',
          'DDT',
          'ORIENTASI UNIT LAIN'
        ],
        'OSO HDT INTERNAL': [
          'TEORI UMUM',
          'TEORI TEKNIS', 
          'SIMULATOR',
          'PENDAMPINGAN INSTRUKTUR',
          'PENDAMPINGAN OPERATOR',
          'TANPA PENDAMPINGAN',
          'PRAKTEK MALAM',
          'DDT',
          'ORIENTASI UNIT LAIN'
        ],
        'OSO HDT EKSTERNAL': [
          'TEORI UMUM',
          'TEORI TEKNIS', 
          'SIMULATOR',
          'PENDAMPINGAN INSTRUKTUR',
          'PENDAMPINGAN OPERATOR',
          'TANPA PENDAMPINGAN',
          'PRAKTEK MALAM',
          'DDT',
          'ORIENTASI UNIT LAIN'
        ],
        'ORP HDT': [
          'TEORI UMUM',
          'TEORI TEKNIS', 
          'SIMULATOR',
          'PENDAMPINGAN INSTRUKTUR',
          'PENDAMPINGAN OPERATOR',
          'TANPA PENDAMPINGAN',
          'PRAKTEK MALAM',
          'DDT',
          'ORIENTASI UNIT LAIN'
        ]
      };
      
      // Add default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '-- Pilih Kegiatan --';
      kegiatanSelect.appendChild(defaultOption);
      
      // Add options for selected jenis pelatihan
      const options = kegiatanOptions[jenisPelatihan] || [];
      options.forEach(kegiatan => {
        const option = document.createElement('option');
        option.value = kegiatan;
        option.textContent = kegiatan;
        kegiatanSelect.appendChild(option);
      });
    }

    // ===== TIMELINE VIEW FUNCTIONS =====

    // Load timeline data + mapping baris spreadsheet
    async function loadTimeline(){
      let arr = [];
      try{
        const res = await fetch(API_URL + '?action=timeframe');
        if(res.ok){
          const data = await res.json();
          if(Array.isArray(data)){
            arr = data.map((x,i)=>({ ...x, row: i+2 }));
          }
        }
      }catch(e){ console.warn(e); }
      if(!arr.length){
        try{ arr = JSON.parse(localStorage.getItem(KEY)||'[]'); } catch(e){ arr=[]; }
        arr = arr.map((x,i)=>({ ...x, row: x.row || (i+2) }));
      }
      return arr;
    }

    function saveLocal(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }

    // CRUD for timeline
    async function addRemote(item){
      const payload = { action: 'add', target: 'timeframe', paket: item.paket, nama: item.nama, mulai: item.mulai, selesai: item.selesai };
      const r = await apiFetch(payload);
      return r?.status === 'success';
    }

    async function editRemote(row, item){
      const payload = { action: 'edit', target: 'timeframe', row: parseInt(row,10), paket: item.paket, nama: item.nama, mulai: item.mulai, selesai: item.selesai };
      const r = await apiFetch(payload);
      return r?.status === 'success';
    }

    async function deleteRemote(row){
      const payload = { action: 'delete', target: 'timeframe', row: parseInt(row,10) };
      const r = await apiFetch(payload);
      return r?.status === 'success';
    }

    // Calculate days between dates
    function daysBetween(start, end) {
      const startDate = new Date(start);
      const endDate = new Date(end);
      const diffTime = endDate - startDate;
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    }

    // Get status based on dates
    function getStatus(start, end) {
      const today = new Date();
      const startDate = new Date(start);
      const endDate = new Date(end);
      
      today.setHours(0, 0, 0, 0);
      startDate.setHours(0, 0, 0, 0);
      endDate.setHours(0, 0, 0, 0);

      if (today < startDate) {
        return 'upcoming';
      } else if (today > endDate) {
        return 'completed';
      } else {
        return 'current';
      }
    }

    // Get status text for display
    function getStatusText(start, end) {
      const status = getStatus(start, end);
      switch(status) {
        case 'current': return 'üîÑ Sedang Berjalan';
        case 'completed': return '‚úÖ Selesai';
        case 'upcoming': return '‚è≥ Akan Datang';
        default: return '‚ùì Tidak Diketahui';
      }
    }

    // Calculate activity duration in days
    function calculateDuration(startDate, endDate) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      const diffTime = end - start;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
      return diffDays;
    }

    // Get color class based on duration
    function getDurationColorClass(duration) {
      if (duration <= 10) {
        return `activity-duration-${duration}`;
      } else {
        return 'activity-duration-long';
      }
    }

    // Generate date columns based on timeline data
    function generateDateColumns() {
      if (STATE.length === 0) {
        COLUMNS = ['no', 'kegiatan', 'status'];
        return;
      }

      // Find the earliest start date and latest end date
      let minDate = null;
      let maxDate = null;

      STATE.forEach(item => {
        if (item.tanggal_mulai) {
          const startDate = new Date(item.tanggal_mulai);
          if (!minDate || startDate < minDate) {
            minDate = startDate;
          }
        }
        if (item.tanggal_selesai) {
          const endDate = new Date(item.tanggal_selesai);
          if (!maxDate || endDate > maxDate) {
            maxDate = endDate;
          }
        }
      });

      // Generate columns (without paket)
      COLUMNS = ['no', 'kegiatan'];
      
      if (minDate && maxDate) {
        // Generate date columns
        const dateColumns = [];
        const currentDate = new Date(minDate);
        
        while (currentDate <= maxDate) {
          const dateKey = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD format
          dateColumns.push(dateKey);
          currentDate.setDate(currentDate.getDate() + 1);
        }
        
        COLUMNS = COLUMNS.concat(dateColumns);
        
        // Add status data for each date to STATE items
        STATE.forEach((item, activityIndex) => {
          // More robust date parsing
          let itemStartDate, itemEndDate;
          
          try {
            // Handle various date formats
            if (item.tanggal_mulai.includes('/')) {
              const [day, month, year] = item.tanggal_mulai.split('/');
              itemStartDate = new Date(year || new Date().getFullYear(), month - 1, day);
            } else {
              itemStartDate = new Date(item.tanggal_mulai);
            }
            
            if (item.tanggal_selesai.includes('/')) {
              const [day, month, year] = item.tanggal_selesai.split('/');
              itemEndDate = new Date(year || new Date().getFullYear(), month - 1, day);
            } else {
              itemEndDate = new Date(item.tanggal_selesai);
            }
          } catch (e) {
            console.error(`Date parsing error for ${item.kegiatan}:`, e);
            itemStartDate = new Date(item.tanggal_mulai);
            itemEndDate = new Date(item.tanggal_selesai);
          }
          
          // Calculate duration and assign unique color based on activity index
          const duration = calculateDuration(item.tanggal_mulai, item.tanggal_selesai);
          item.duration = duration;
          // Use activity index for unique colors, cycling through available colors
          const colorIndex = (activityIndex % 10) + 1;
          item.colorClass = colorIndex <= 10 ? `activity-duration-${colorIndex}` : 'activity-duration-long';
          
          console.log(`Activity ${activityIndex}: ${item.kegiatan}`);
          console.log(`  Start: ${item.tanggal_mulai} -> ${itemStartDate.toDateString()}`);
          console.log(`  End: ${item.tanggal_selesai} -> ${itemEndDate.toDateString()}`);
          console.log(`  Color: ${item.colorClass}`);
          
          dateColumns.forEach(dateKey => {
            const checkDate = new Date(dateKey);
            
            // Normalize dates to avoid timezone issues
            const normalizedCheckDate = new Date(checkDate.getFullYear(), checkDate.getMonth(), checkDate.getDate());
            const normalizedStartDate = new Date(itemStartDate.getFullYear(), itemStartDate.getMonth(), itemStartDate.getDate());
            const normalizedEndDate = new Date(itemEndDate.getFullYear(), itemEndDate.getMonth(), itemEndDate.getDate());
            
            // Check if this date falls within the activity period
            if (normalizedCheckDate >= normalizedStartDate && normalizedCheckDate <= normalizedEndDate) {
              item[dateKey] = ' '; // Empty space for active period (just for color coding)
              if (item.kegiatan === 'TEORI UMUM') {
                console.log(`  Date ${dateKey} (${normalizedCheckDate.toDateString()}) is ACTIVE for TEORI UMUM`);
              }
            } else {
              item[dateKey] = ''; // Empty for dates outside activity period
              if (item.kegiatan === 'TEORI UMUM') {
                console.log(`  Date ${dateKey} (${normalizedCheckDate.toDateString()}) is INACTIVE for TEORI UMUM`);
              }
            }
          });
        });
      }
    }

    // Format date for display
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Render timeline
    async function renderTimeline() {
      const container = document.getElementById('timelineContent');
      if (!container) return;

      TIMELINE_DATA = await loadTimeline();

      // Get active filter from dropdown
      const filterSelect = document.getElementById('timelineFilter');
      const activeFilter = filterSelect ? filterSelect.value : 'all';
      
      // Filter data based on selection
      let filteredData = TIMELINE_DATA;
      if (activeFilter === 'current') {
        filteredData = TIMELINE_DATA.filter(item => getStatus(item.mulai, item.selesai) === 'current');
      } else if (activeFilter === 'upcoming') {
        filteredData = TIMELINE_DATA.filter(item => getStatus(item.mulai, item.selesai) === 'upcoming');
      } else if (activeFilter === 'completed') {
        filteredData = TIMELINE_DATA.filter(item => getStatus(item.mulai, item.selesai) === 'completed');
      }

      if (filteredData.length === 0) {
        container.innerHTML = '<div class="timeline-empty">Tidak ada data timeline untuk filter yang dipilih.</div>';
        return;
      }

      // Sort by start date
      filteredData.sort((a, b) => new Date(a.mulai) - new Date(b.mulai));

      let html = '';
      filteredData.forEach(item => {
        const duration = daysBetween(item.mulai, item.selesai);
        
        html += `
          <div class="timeline-item">
            <div class="timeline-content">
              <div class="timeline-date">${formatDate(item.mulai)} <-> ${formatDate(item.selesai)}</div>
              <div class="timeline-title-item">${item.paket || 'Tanpa Nama'}</div>
              <div class="timeline-subtitle">${item.nama || 'Tanpa Deskripsi'}</div>
              <div class="timeline-duration">
                <span class="duration-badge">${duration} hari</span>
              </div>
              <div class="timeline-actions">
                <button class="btn btn-outline-primary btn-sm" onclick="editTimelineItem(${item.row})">Edit</button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteTimelineItem(${item.row})">Hapus</button>
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Filter timeline based on dropdown selection
    function filterTimeline() {
      renderTimeline();
    }

    // Edit timeline item
    function editTimelineItem(row) {
      (async ()=>{
        const arr = await loadTimeline();
        const idx = arr.findIndex(x=>x.row===row);
        if(idx===-1) return;
        const item = arr[idx];
        const paket = prompt('Nama pelatihan', item.paket||''); if(paket===null) return;
        const nama = prompt('Kegiatan pelatihan', item.nama||''); if(nama===null) return;
        const mulai = prompt('Tanggal mulai (YYYY-MM-DD)', item.mulai||''); if(mulai===null) return;
        const selesai = prompt('Tanggal selesai (YYYY-MM-DD)', item.selesai||''); if(selesai===null) return;
        const updated = { paket: paket.trim(), nama: nama.trim(), mulai, selesai };
        const ok = await editRemote(row, updated);
        if(!ok){
          const a = await loadTimeline();
          const idxx = a.findIndex(x=>x.row===row);
          if(idxx!==-1){ a[idxx] = { ...a[idxx], ...updated }; saveLocal(a); }
        }
        await renderTimeline();
        showSuccessMessage("Timeline berhasil diupdate!");
      })();
    }

    // Delete timeline item
    async function deleteTimelineItem(row){
      if(!confirm('Yakin hapus timeline ini?')) return;
      const ok = await deleteRemote(row);
      if(!ok){
        const arr = (await loadTimeline()).filter(x=>x.row!==row);
        saveLocal(arr);
      }
      await renderTimeline();
      showSuccessMessage("Timeline berhasil dihapus!");
    }

    // ===== EVENT LISTENERS =====

    document.addEventListener("DOMContentLoaded", () => {
      // Table view event listeners
      const activityForm = document.getElementById('activityForm');
      if (activityForm) {
        activityForm.addEventListener('submit', onSubmitForm);
      }
      
      const btnCancel = document.getElementById('btnCancel');
      if (btnCancel) {
        btnCancel.addEventListener('click', resetForm);
      }
      
      const btnAddColumn = document.getElementById('btnAddColumn');
      if (btnAddColumn) {
        btnAddColumn.addEventListener('click', addColumn);
      }
      
      const btnRefresh = document.getElementById('btnRefresh');
      if (btnRefresh) {
        btnRefresh.addEventListener('click', reload);
      }

      // Timeline view event listeners
      const timelineForm = document.getElementById('timelineForm');
      if (timelineForm) {
        timelineForm.addEventListener('submit', async e=>{
          e.preventDefault();
          const f = new FormData(e.target);
          const obj = {
            paket: (f.get('paket')||'').trim(),
            nama: (f.get('kegiatan')||'').trim(),
            mulai: f.get('mulai'),
            selesai: f.get('selesai')
          };
          const ok = await addRemote(obj);
          if(!ok){
            const arr = await loadTimeline();
            arr.push(obj);
            saveLocal(arr);
          }
          e.target.reset();
          await renderTimeline();
          showSuccessMessage("Timeline berhasil ditambahkan!");
        });
      }

      const clearTimelineBtn = document.getElementById('clearAllTimeline');
      if (clearTimelineBtn) {
        clearTimelineBtn.addEventListener('click', async () => {
          if (!confirm('Reset: hapus data lokal timeline (tidak menghapus data di spreadsheet) dan setel ulang form?')) return;
          document.getElementById('timelineForm').reset();
          localStorage.removeItem(KEY);
          await renderTimeline();
          showInfoMessage("Data timeline lokal telah direset.");
        });
      }

      // Tab switching event listeners
      const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
      tabButtons.forEach(button => {
        button.addEventListener('shown.bs.tab', function (e) {
          const target = e.target.getAttribute('data-bs-target');
          if (target === '#table-view') {
            // Load table data when switching to table view
            reload();
          } else if (target === '#timeline-view') {
            // Load timeline data when switching to timeline view
            renderTimeline();
          }
        });
      });

      // Initial load based on active tab
      const activeTab = document.querySelector('.view-toggle .nav-link.active');
      if (activeTab && activeTab.getAttribute('data-bs-target') === '#timeline-view') {
        renderTimeline();
      } else {
        reload();
      }
      
      // Ensure timeline data is loaded on page load
      renderTimeline();
    });

    // Make functions globally available
    window.onEdit = onEdit;
    window.onDelete = onDelete;
    window.removeMessage = removeMessage;
    window.editTimelineItem = editTimelineItem;
    window.deleteTimelineItem = deleteTimelineItem;
    window.filterTableByTraining = filterTableByTraining;
    window.filterTimeline = filterTimeline;
  </script>
</body>
</html>
