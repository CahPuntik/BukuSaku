<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Catatan</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="theme-color" content="#fda085">
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyCCBwvqjaG_M0a7308ZfDDJb7Mm3LjHxeI",
      authDomain: "buku-saku-instruktur.firebaseapp.com",
      projectId: "buku-saku-instruktur",
      storageBucket: "buku-saku-instruktur.firebasestorage.app",
      messagingSenderId: "180222950163",
      appId: "1:180222950163:web:3331e9673249098aa038e6"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Make Firebase available globally
    window.firebase = { app, db, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy };
  </script>
  
  <style>
    body {
      background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
      min-height: 100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    
    .btn-back {
      background: linear-gradient(90deg, #f76b1c 60%, #fda085 100%);
      color: #fff;
      margin-top: 18px;
      padding: 10px 36px;
    }
    
    .btn-back:hover {
      background: linear-gradient(90deg, #fda085 0%, #f76b1c 100%);
      color: #fff;
    }

    /* container gaya timeframe */
    .container-card {
      max-width: 900px;
      margin: 10px auto;
      padding: 28px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      position: relative;
      overflow: hidden;
    }

    /* header gaya timeframe */
    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }
    
    .avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fda085 60%, #f6d365 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: #fff;
      margin-right: 12px;
      box-shadow: 0 2px 8px rgba(253,160,133,0.18);
    }
    
    .dashboard-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #f76b1c;
      letter-spacing: 1px;
    }
    
    .admin-desc, .text-muted { color: #666; }

    .offcanvas {
      background: transparent;
      border: none;
      box-shadow: none;
      width: 90px !important;
    }
    
    .offcanvas-header {
      display: none;
    }
    
    .offcanvas-title {
      color: #f76b1c;
      font-weight: 700;
      letter-spacing: 1px;
    }
    
    .nav-link {
      font-weight: 500;
      color: #f76b1c;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      width: 50px;
      height: 50px;
      margin: 0 auto;
    }
    
    .nav-link:hover, .nav-link.active {
      background: linear-gradient(90deg, #fda08522 0%, #f6d36522 100%);
      color: #f76b1c;
    }
    
    @media (max-width: 900px) {
      .container-card {
        padding: 18px 6px 16px 6px;
        max-width: 90vw;
      }
      
      .dashboard-header {
        flex-direction: column;
        gap: 8px;
        align-items: center;
        justify-content: center;
      }
      
      .dashboard-title {
        text-align: center;
        width: 100%;
      }
      
      .avatar {
        margin-right: 0;
        margin-bottom: 6px;
      }
      
      .offcanvas.offcanvas-start{
        width: 82%;
        max-width: 360px;
        left: 0;
        top: 0;
        height: 100%;
        box-shadow: 2px 8px 40px rgba(0,0,0,0.12);
        border-top-right-radius: 18px;
        border-bottom-right-radius: 18px;
        font-size: 1.4rem;
      }
      
      .offcanvas-backdrop {
        background-color: rgba(0,0,0,0.35);
      }
      
      .list-group-item {
        font-size: 1.4rem;
      }
    }
    
    /* Note Card Styling */
    .note-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 15px;
      overflow: hidden;
      transition: all 0.3s ease;
      border-left: 4px solid #fda085;
    }
    
    .note-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .note-header {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
      color: #fff;
      padding: 12px 15px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .note-date {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    
    .note-content {
      padding: 15px;
      line-height: 1.6;
      color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .note-content.collapsed {
      max-height: 60px;
      overflow: hidden;
      position: relative;
    }
    
    .note-content.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      height: 30px;
      width: 100%;
      background: linear-gradient(transparent, white);
    }
    
    .note-content.expanded {
      max-height: none;
    }
    
    .expand-indicator {
      font-size: 0.8rem;
      color: #666;
      font-style: italic;
      margin-top: 5px;
    }
    
    .note-actions {
      padding: 10px 15px;
      background: #f8f9fa;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    
    /* Form Styling */
    .note-form {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .form-control:focus {
      border-color: #fda085;
      box-shadow: 0 0 0 0.2rem rgba(253, 160, 133, 0.25);
    }
    
    .btn-primary {
      background: linear-gradient(90deg, #f76b1c, #fda085);
      border: none;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background: linear-gradient(90deg, #fda085, #f76b1c);
      transform: translateY(-1px);
    }
    
    /* Search and filter */
    .search-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .search-input {
      flex: 1;
      min-width: 200px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      display: block;
    }
  </style>
</head>
<body>
  <!-- Tombol buka sidebar -->
  <button class="btn btn-outline-secondary mb-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">‚ò∞</button>

  <!-- Sidebar -->
  <nav class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">üìö Buku Saku</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body px-1">
      <ul class="nav flex-column">
        <li class="nav-item mb-2"><a class="nav-link" href="dashboard.html">üè†</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="prosedur2.html">üìë</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="rostercuti2.html">üóìÔ∏è</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="administrasi.html">üóÇÔ∏è</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="preposttest.html">üìù</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="timeframe.html">üïí</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="progress-table.html">‚è∞</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="daily.html">üìò</a></li>
        <li class="nav-item mb-2"><a class="nav-link active" href="catatan.html">üìã</a></li>
        <li class="nav-item mt-4"><a class="nav-link text-danger" href="index.html">üö™</a></li>
      </ul>
    </div>
  </nav>

  <div class="container container-card">
    <div class="dashboard-header">
      <div class="avatar">üìã</div>
      <div class="dashboard-title">Catatan</div>
    </div>
    
    <div class="mb-3">
      <p class="admin-desc mb-0">Buat dan kelola catatan penting. Data tersimpan di Firebase.</p>
    </div>

    <!-- New Note Button -->
    <div class="mb-3">
      <button type="button" class="btn btn-primary" id="btnNewNote">
        ‚ûï
      </button>
    </div>

    <!-- Form Tambah Catatan (Hidden by default) -->
    <div class="note-form" id="noteFormContainer" style="display: none;">
      <form id="noteForm">
        <div class="mb-3">
          <label for="noteTitle" class="form-label fw-bold">Judul Catatan *</label>
          <input type="text" class="form-control" id="noteTitle" placeholder="Masukkan judul catatan..." required>
        </div>
        
        <div class="mb-3">
          <label for="noteContent" class="form-label fw-bold">Isi Catatan *</label>
          <textarea class="form-control" id="noteContent" rows="4" placeholder="Tulis catatan Anda di sini..." required></textarea>
        </div>
        
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <span id="submitIcon"></span> <span id="submitText">Simpan</span>
          </button>
          <button type="button" class="btn btn-secondary" id="btnCancel">Batal</button>
        </div>
        
        <input type="hidden" id="editingNoteId">
      </form>
    </div>

    <!-- Search and Filter -->
    <div class="search-controls">
      <input type="text" class="form-control search-input" id="searchInput" placeholder="üîç Cari catatan...">
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center py-4" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-2">Memuat catatan...</div>
    </div>

    <!-- Notes Container -->
    <div id="notesContainer">
      <!-- Notes will be rendered here -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <span style="font-size: 3rem;">üìù</span>
      <h5>Belum Ada Catatan</h5>
      <p class="text-muted">Mulai buat catatan pertama Anda dengan mengisi form di atas.</p>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // ÔøΩ Notes Management System
    let notesData = [];
    let editingNoteId = null;
    let notesCache = null; // Cache for notes data
    let cacheTimestamp = null;
    const CACHE_DURATION = 2 * 60 * 1000; // 2 minutes cache duration

    // Initialize page on load
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      loadNotes();
    });

    function setupEventListeners() {
      // New note button
      document.getElementById('btnNewNote').addEventListener('click', showNoteForm);
      
      // Form submit
      document.getElementById('noteForm').addEventListener('submit', handleSubmitNote);
      
      // Cancel button
      document.getElementById('btnCancel').addEventListener('click', hideNoteForm);
      
      // Search functionality
      document.getElementById('searchInput').addEventListener('input', filterNotes);
    }

    // Load notes from Firebase with caching
    async function loadNotes() {
      try {
        // Check if we have valid cached data
        if (notesCache && cacheTimestamp && 
            (Date.now() - cacheTimestamp < CACHE_DURATION)) {
          console.log('Using cached notes data');
          notesData = notesCache;
          renderNotes();
          return;
        }
        
        showLoading();
        
        if (!window.firebase || !window.firebase.db) {
          console.log('Firebase not initialized yet, retrying...');
          setTimeout(loadNotes, 500);
          return;
        }
        
        const { db, collection, getDocs } = window.firebase;
        const notesCollection = collection(db, 'notes');
        
        // Add timeout to prevent hanging
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Request timeout')), 10000); // 10 second timeout
        });
        
        // Remove orderBy to make query faster - we'll sort locally
        const queryPromise = getDocs(notesCollection);
        
        // Race between fetch and timeout
        const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
        
        notesData = [];
        querySnapshot.forEach((doc) => {
          notesData.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Sort by creation date locally (faster than Firebase orderBy)
        notesData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        // Cache the data
        notesCache = [...notesData];
        cacheTimestamp = Date.now();
        
        console.log('Notes loaded from Firebase:', notesData);
        renderNotes();
        hideLoading();
      } catch (error) {
        console.error('Error loading notes:', error);
        hideLoading();
        
        let errorMessage = "Gagal memuat catatan!";
        if (error.message.includes('timeout')) {
          errorMessage = "‚è±Ô∏è Loading terlalu lama. Silakan refresh halaman atau coba lagi.";
        }
        
        // Show error message to user
        const container = document.getElementById('notesContainer');
        container.innerHTML = `
          <div class="alert alert-warning text-center" role="alert">
            <h6>${errorMessage}</h6>
            <button class="btn btn-primary btn-sm mt-2" onclick="loadNotes()">üîÑ Coba Lagi</button>
          </div>
        `;
        
        showEmptyState();
      }
    }

    // Save note to Firebase
    async function saveNote(noteData) {
      try {
        const { db, collection, addDoc } = window.firebase;
        const notesCollection = collection(db, 'notes');
        const docRef = await addDoc(notesCollection, noteData);
        console.log('Note saved with ID:', docRef.id);
        
        // Clear cache when data is modified
        notesCache = null;
        cacheTimestamp = null;
        
        return docRef.id;
      } catch (error) {
        console.error('Error saving note:', error);
        throw error;
      }
    }

    // Update note in Firebase
    async function updateNote(noteId, noteData) {
      try {
        const { db, doc, updateDoc } = window.firebase;
        const noteDoc = doc(db, 'notes', noteId);
        await updateDoc(noteDoc, noteData);
        console.log('Note updated successfully');
        
        // Clear cache when data is modified
        notesCache = null;
        cacheTimestamp = null;
      } catch (error) {
        console.error('Error updating note:', error);
        throw error;
      }
    }

    // Delete note from Firebase
    async function deleteNote(noteId) {
      try {
        const { db, doc, deleteDoc } = window.firebase;
        const noteDoc = doc(db, 'notes', noteId);
        await deleteDoc(noteDoc);
        console.log('Note deleted successfully');
        
        // Clear cache when data is modified
        notesCache = null;
        cacheTimestamp = null;
      } catch (error) {
        console.error('Error deleting note:', error);
        throw error;
      }
    }

    // Handle form submission
    async function handleSubmitNote(event) {
      event.preventDefault();
      
      const title = document.getElementById('noteTitle').value.trim();
      const content = document.getElementById('noteContent').value.trim();
      
      if (!title || !content) {
        alert('Judul dan isi catatan harus diisi!');
        return;
      }
      
      try {
        const noteData = {
          title: title,
          content: content,
          updatedAt: new Date().toISOString()
        };
        
        if (editingNoteId) {
          // Update existing note
          await updateNote(editingNoteId, noteData);
          alert('‚úÖ Catatan berhasil diperbarui!');
        } else {
          // Add new note
          noteData.createdAt = new Date().toISOString();
          const docId = await saveNote(noteData);
          alert('‚úÖ Catatan berhasil ditambahkan!');
        }
        
        hideNoteForm();
        loadNotes();
      } catch (error) {
        console.error('Error saving note:', error);
        alert('‚ùå Gagal menyimpan catatan. Silakan coba lagi.');
      }
    }

    // Show note form
    function showNoteForm() {
      document.getElementById('noteFormContainer').style.display = 'block';
      document.getElementById('btnNewNote').style.display = 'none';
      document.getElementById('noteTitle').focus();
    }

    // Hide note form
    function hideNoteForm() {
      document.getElementById('noteFormContainer').style.display = 'none';
      document.getElementById('btnNewNote').style.display = 'inline-block';
      resetForm();
    }

    // Reset form
    function resetForm() {
      document.getElementById('noteForm').reset();
      document.getElementById('editingNoteId').value = '';
      document.getElementById('submitIcon').textContent = '‚ûï';
      document.getElementById('submitText').textContent = 'Tambah Catatan';
      editingNoteId = null;
    }

    // Edit note
    function editNote(noteId) {
      const note = notesData.find(n => n.id === noteId);
      if (!note) return;
      
      document.getElementById('noteTitle').value = note.title;
      document.getElementById('noteContent').value = note.content;
      document.getElementById('editingNoteId').value = noteId;
      document.getElementById('submitIcon').textContent = '‚úèÔ∏è';
      document.getElementById('submitText').textContent = 'Perbarui Catatan';
      
      editingNoteId = noteId;
      
      // Show form and hide new button
      showNoteForm();
      
      // Scroll to form
      document.getElementById('noteForm').scrollIntoView({ behavior: 'smooth' });
    }

    // Delete note with confirmation
    async function confirmDeleteNote(noteId) {
      const note = notesData.find(n => n.id === noteId);
      if (!note) return;
      
      if (confirm(`Yakin ingin menghapus catatan "${note.title}"?\n\nData yang dihapus tidak dapat dikembalikan.`)) {
        try {
          await deleteNote(noteId);
          alert('‚úÖ Catatan berhasil dihapus!');
          loadNotes();
        } catch (error) {
          console.error('Error deleting note:', error);
          alert('‚ùå Gagal menghapus catatan. Silakan coba lagi.');
        }
      }
    }

    // Render notes
    function renderNotes(filteredNotes = notesData) {
      const container = document.getElementById('notesContainer');
      const emptyState = document.getElementById('emptyState');
      
      if (filteredNotes.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      container.innerHTML = filteredNotes.map(note => {
        const createdDate = new Date(note.createdAt).toLocaleDateString('id-ID', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        // Create preview (first 100 characters)
        const preview = note.content.length > 100 
          ? note.content.substring(0, 100) + '...' 
          : note.content;
        
        const showExpand = note.content.length > 100;
        
        return `
          <div class="note-card">
            <div class="note-header">
              <div>
                <span>üìù</span>
                <strong>${note.title}</strong>
              </div>
              <div class="note-date">${createdDate}</div>
            </div>
            <div class="note-content collapsed" id="content-${note.id}" onclick="toggleNoteContent('${note.id}')">
              <div id="preview-${note.id}">
                ${preview.replace(/\n/g, '<br>')}
                ${showExpand ? '<div class="expand-indicator">üëÜ Klik untuk melihat selengkapnya</div>' : ''}
              </div>
              <div id="full-${note.id}" style="display: none;">
                ${note.content.replace(/\n/g, '<br>')}
                <div class="expand-indicator">üëÜ Klik untuk menyembunyikan</div>
              </div>
            </div>
            <div class="note-actions">
              <button class="btn btn-sm btn-warning" onclick="editNote('${note.id}')">
                ‚úèÔ∏è Edit
              </button>
              <button class="btn btn-sm btn-danger" onclick="confirmDeleteNote('${note.id}')">
                üóëÔ∏è Hapus
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Toggle note content expand/collapse
    function toggleNoteContent(noteId) {
      const contentDiv = document.getElementById(`content-${noteId}`);
      const previewDiv = document.getElementById(`preview-${noteId}`);
      const fullDiv = document.getElementById(`full-${noteId}`);
      
      if (contentDiv.classList.contains('collapsed')) {
        // Expand
        contentDiv.classList.remove('collapsed');
        contentDiv.classList.add('expanded');
        previewDiv.style.display = 'none';
        fullDiv.style.display = 'block';
      } else {
        // Collapse
        contentDiv.classList.remove('expanded');
        contentDiv.classList.add('collapsed');
        previewDiv.style.display = 'block';
        fullDiv.style.display = 'none';
      }
    }

    // Filter notes based on search and category
    function filterNotes() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      let filtered = notesData;
      
      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(note => 
          note.title.toLowerCase().includes(searchTerm) ||
          note.content.toLowerCase().includes(searchTerm)
        );
      }
      
      renderNotes(filtered);
    }

    // Show loading indicator
    function showLoading() {
      const container = document.getElementById('notesContainer');
      const emptyState = document.getElementById('emptyState');
      const loadingIndicator = document.getElementById('loadingIndicator');
      
      container.innerHTML = '';
      emptyState.style.display = 'none';
      loadingIndicator.style.display = 'block';
    }

    // Hide loading indicator
    function hideLoading() {
      document.getElementById('loadingIndicator').style.display = 'none';
    }

    // Show empty state
    function showEmptyState() {
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('notesContainer').innerHTML = '';
      document.getElementById('loadingIndicator').style.display = 'none';
    }
  </script>
</body>
</html>