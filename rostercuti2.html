<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Roster Cuti</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#fda085">
  <style>
    body {
      background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
      min-height: 100vh;
    }
    .roster-container {
      max-width: 900px;
      margin: 10px auto;
      padding: 32px 28px 24px 28px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      position: relative;
      overflow: hidden;
    }
    .roster-header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 18px;
      gap: 12px;
    }
    .avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fda085 60%, #f6d365 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      color: #fff;
      box-shadow: 0 2px 8px rgba(253,160,133,0.18);
    }
    .roster-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #f76b1c;
      letter-spacing: 1px;
    }
    .controls .form-control, .controls .form-select {
      height: 48px;
      border-radius: 8px;
      border: 1px solid #fda08544;
    }
    .table thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
      text-align: center;
    }
    .table-bordered > :not(caption) > * > * {
      border-color: #fda08555;
    }
    .table-hover tbody tr:hover {
      background: linear-gradient(90deg, #fda08522 0%, #f6d36522 100%);
      transition: background 0.18s;
    }
    .btn-primary, .btn-success, .btn-warning, .btn-danger, .btn-back {
      border: none;
      font-weight: 600;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(253,160,133,0.13);
      transition: background 0.18s, box-shadow 0.18s;
    }
    .btn-primary {
      background: linear-gradient(90deg, #f76b1c 60%, #fda085 100%);
      color: #fff;
    }
    .btn-primary:hover {
      background: linear-gradient(90deg, #fda085 0%, #f76b1c 100%);
      color: #fff;
    }
    .btn-back {
      background: linear-gradient(90deg, #f76b1c 60%, #fda085 100%);
      color: #fff;
      margin-top: 18px;
      padding: 10px 36px;
    }
    .btn-back:hover {
      background: linear-gradient(90deg, #fda085 0%, #f76b1c 100%);
      color: #fff;
    }
    .btn-outline-secondary, .btn-outline-primary {
      border-radius: 8px;
    }
    .badge-status {
      font-size: .95rem;
      padding: 6px 16px;
      border-radius: 8px;
      font-weight: 500;
    }
    
    /* Status berdasarkan tanggal - Override Bootstrap table styles */
    .table tbody tr.row-expired {
      background-color: #ffebee !important; /* Merah muda untuk yang sudah lewat */
    }
    .table tbody tr.row-expired:hover {
      background-color: #ffcdd2 !important;
    }
    .table tbody tr.row-expired td {
      background-color: transparent !important; /* Pastikan td tidak override */
    }
    
    .table tbody tr.row-active {
      background-color: #e8f5e8 !important; /* Hijau muda untuk yang sedang berlangsung */
    }
    .table tbody tr.row-active:hover {
      background-color: #c8e6c9 !important;
    }
    .table tbody tr.row-active td {
      background-color: transparent !important; /* Pastikan td tidak override */
    }
    
    .table tbody tr.row-upcoming {
      background-color: inherit; /* Default untuk yang akan datang */
    }
    .offcanvas {
      background: #fff8f3;
      border-top-right-radius: 18px;
      border-bottom-right-radius: 18px;
      box-shadow: 2px 0 16px rgba(253,160,133,0.08);
    }
    .offcanvas-title {
      color: #f76b1c;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .nav-link {
      font-weight: 500;
      color: #f76b1c;
      border-radius: 8px;
    }
    .nav-link:hover, .nav-link.active {
      background: linear-gradient(90deg, #fda08522 0%, #f6d36522 100%);
      color: #f76b1c;
    }
    @media (max-width: 900px) {
      .roster-container {
        padding: 18px 6px 16px 6px;
        max-width: 90vw;
      }
      .roster-header {
        flex-direction: column;
        gap: 8px;
        align-items: center;
        justify-content: center;
      }
      .roster-title {
        text-align: center;
        width: 100%;
      }
      .avatar {
        margin-right: 0;
        margin-bottom: 6px;
      }
      .offcanvas.offcanvas-start{
        width: 82%;
        max-width: 360px;
        left: 0;
        top: 0;
        height: 100%;
        box-shadow: 2px 8px 40px rgba(0,0,0,0.12);
        border-top-right-radius: 18px;
        border-bottom-right-radius: 18px;
        font-size: 1.4rem;
      }
      .offcanvas-backdrop {
        background-color: rgba(0,0,0,0.35);
      }
      .list-group-item {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <!-- Tombol buka sidebar -->
<button class="btn btn-outline-secondary mb-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
  ‚ò∞ Menu
</button>

  <!-- Sidebar Offcanvas -->
  <nav class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">üìö Buku Saku</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body px-2">
      <ul class="nav flex-column">
        <li class="nav-item mb-2"><a class="nav-link" href="dashboard.html">üè† Dashboard</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="prosedur2.html">üìë Prosedur</a></li>
        <li class="nav-item mb-2"><a class="nav-link active" href="rostercuti2.html">üóìÔ∏è Roster Cuti</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="administrasi.html">üóÇÔ∏è Administrasi</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="preposttest.html">üìù Pre/Post Test</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="timeframe.html">üïí Jadwal Pelatihan</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="daily.html">üìò Daily Activity</a></li>
        <li class="nav-item mt-4"><a class="nav-link text-danger" href="login.html">üö™ Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="roster-container">
    <div class="roster-header">
      <div class="avatar">üóìÔ∏è</div>
      <div class="roster-title">ROSTER CUTI</div>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <div></div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">‚ûï Tambah Data</button>
    </div>

    <!-- Controls -->
    <div class="row g-2 controls mb-3">
      <div class="col-12 col-md-6">
        <input id="searchInput" class="form-control" type="text" placeholder="üîç Cari nama / NRP / keterangan‚Ä¶">
      </div>
      <div class="col-6 col-md-3">
        <select id="bulanFilter" class="form-select">
          <option value="">Filter Bulan (Semua)</option>
          <option value="01">Januari</option>
          <option value="02">Februari</option>
          <option value="03">Maret</option>
          <option value="04">April</option>
          <option value="05">Mei</option>
          <option value="06">Juni</option>
          <option value="07">Juli</option>
          <option value="08">Agustus</option>
          <option value="09">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
          <option value="12">Desember</option>
        </select>
      </div>
      <div class="col-6 col-md-3">
        <select id="statusFilter" class="form-select">
          <option value="">Filter Status (Semua)</option>
          <option value="Cuti">Cuti</option>
          <option value="Izin">Izin</option>
          <option value="Sakit">Sakit</option>
          <option value="Dinas">Dinas</option>
          <option value="Training">Training</option>
        </select>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <small class="text-muted" id="resultInfo">Menampilkan semua data</small>
      <div class="btn-group">
        <button id="resetBtn" class="btn btn-outline-secondary btn-sm">Reset</button>
        <button onclick="window.print()" class="btn btn-outline-primary btn-sm">Print</button>
      </div>
    </div>

    <!-- Legend Keterangan Warna -->
    <div class="mb-3">
      <small class="text-muted fw-bold">Keterangan Warna:</small>
      <div class="d-flex flex-wrap gap-3 mt-2">
        <div class="d-flex align-items-center">
          <div style="width: 20px; height: 20px; background-color: #ffebee; border: 1px solid #ddd; border-radius: 4px; margin-right: 8px;"></div>
          <small class="text-muted">Sudah Berakhir</small>
        </div>
        <div class="d-flex align-items-center">
          <div style="width: 20px; height: 20px; background-color: #e8f5e8; border: 1px solid #ddd; border-radius: 4px; margin-right: 8px;"></div>
          <small class="text-muted">Sedang Berlangsung</small>
        </div>
        <div class="d-flex align-items-center">
          <div style="width: 20px; height: 20px; background-color: #fff; border: 1px solid #ddd; border-radius: 4px; margin-right: 8px;"></div>
          <small class="text-muted">Akan Datang</small>
        </div>
      </div>
    </div>

    <!-- Tabel -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle" id="cutiTable">
        <thead>
          <tr>
            <th style="min-width:20px;">No</th>
            <th style="min-width:120px;">Nama</th>
            <th style="min-width:80px;">NRP</th>
            <th style="min-width:100px;">Tanggal Mulai</th>
            <th style="min-width:100px;">Tanggal Selesai</th>
            <th style="min-width:80px;">Lama (hari)</th>
            <th style="min-width:80px;">Status</th>
            <th style="min-width:100px;">Keterangan</th>
            <th style="min-width:150px;">Aksi</th>
          </tr>
        </thead>
        <tbody id="cutiBody"></tbody>
      </table>
    </div>
    <div class="text-center mt-4">
      <a href="dashboard.html" class="btn btn-back">‚¨ÖÔ∏è Kembali ke Dashboard</a>
    </div>
  </div>

  <!-- Modal Tambah -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addForm">
          <div class="modal-header">
            <h5 class="modal-title">Tambah Data Cuti</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" class="form-control mb-2" id="nama" placeholder="Nama" required>
            <input type="text" class="form-control mb-2" id="nrp" placeholder="NRP" required>
            <input type="date" class="form-control mb-2" id="tglMulai" required>
            <input type="date" class="form-control mb-2" id="tglSelesai" required>
            <select class="form-select mb-2" id="status" required>
              <option value="">Pilih Status</option>
              <option value="Cuti">Cuti</option>
              <option value="Izin">Izin</option>
              <option value="Sakit">Sakit</option>
              <option value="Dinas">Dinas</option>
              <option value="Training">Training</option>
            </select>
            <input type="text" class="form-control mb-2" id="keterangan" placeholder="Keterangan" required>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button class="btn btn-success" type="submit">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Edit -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editForm">
          <div class="modal-header">
            <h5 class="modal-title">Edit Data Cuti</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editIndex">
            <input type="text" class="form-control mb-2" id="editNama" required>
            <input type="text" class="form-control mb-2" id="editNrp" required>
            <input type="date" class="form-control mb-2" id="editMulai" required>
            <input type="date" class="form-control mb-2" id="editSelesai" required>
            <select class="form-select mb-2" id="editStatus" required>
              <option value="Cuti">Cuti</option>
              <option value="Izin">Izin</option>
              <option value="Sakit">Sakit</option>
              <option value="Dinas">Dinas</option>
              <option value="Training">Training</option>
            </select>
            <input type="text" class="form-control mb-2" id="editKet" required>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button class="btn btn-success" type="submit">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyCbEPQIcaKgBU-jQbmSeC_1R1tXh1Y3hA7d3q8VMCr46qtpm6lanKbrebZ-1OD2Q7h/exec"; 
    const tbody = document.getElementById("cutiBody");
    const addForm = document.getElementById("addForm");
    const editForm = document.getElementById("editForm");

    function formatDate(isoStr){
      const d = new Date(isoStr);
      const day = String(d.getDate()).padStart(2,'0');
      const month = String(d.getMonth()+1).padStart(2,'0');
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    async function loadData(){
      try {
        const res = await fetch(API_URL + "?action=roster");
        const data = await res.json();
        renderTableData(data);
      } catch (error) {
        console.log("API error, using test data:", error);
        // Test data untuk debugging
        const testData = [
          {
            nama: "Test User 1",
            nrp: "12345",
            tglMulai: "2025-09-01", // Sudah lewat (merah)
            tglSelesai: "2025-09-10",
            lama: "9",
            status: "Cuti",
            ket: "Test expired"
          },
          {
            nama: "Test User 2", 
            nrp: "67890",
            tglMulai: "2025-09-20", // Sedang berlangsung (hijau)
            tglSelesai: "2025-09-25",
            lama: "5",
            status: "Izin",
            ket: "Test active"
          },
          {
            nama: "Test User 3",
            nrp: "11111", 
            tglMulai: "2025-10-01", // Akan datang (default)
            tglSelesai: "2025-10-05",
            lama: "4",
            status: "Cuti",
            ket: "Test upcoming"
          }
        ];
        renderTableData(testData);
      }
    }
    
    function renderTableData(data) {
      tbody.innerHTML = "";
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Set ke awal hari untuk perbandingan yang tepat
      console.log("Today:", today);
      
      data.forEach((row,i)=>{
        let badgeClass = "secondary";
        if(row.status==="Cuti") badgeClass = "success";
        else if(row.status==="Izin") badgeClass = "warning text-dark";
        else if(row.status==="Sakit") badgeClass = "danger";
        else if(row.status==="Dinas") badgeClass = "info text-dark";
        else if(row.status==="Training") badgeClass = "primary";
        
        // Tentukan status berdasarkan tanggal
        // Parsing tanggal dengan lebih robust
        let startDate, endDate;
        
        // Jika format tanggal dari API adalah DD/MM/YYYY, konversi ke format yang benar
        if (typeof row.tglMulai === 'string' && row.tglMulai.includes('/')) {
          const [day, month, year] = row.tglMulai.split('/');
          startDate = new Date(year, month - 1, day);
        } else {
          startDate = new Date(row.tglMulai);
        }
        
        if (typeof row.tglSelesai === 'string' && row.tglSelesai.includes('/')) {
          const [day, month, year] = row.tglSelesai.split('/');
          endDate = new Date(year, month - 1, day);
        } else {
          endDate = new Date(row.tglSelesai);
        }
        
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
        
        let rowClass = "";
        if (endDate < today) {
          // Sudah berakhir - merah
          rowClass = "row-expired";
          console.log("Row expired:", row.nama, "End:", endDate, "Today:", today);
        } else if (startDate <= today && today <= endDate) {
          // Sedang berlangsung - hijau
          rowClass = "row-active";
          console.log("Row active:", row.nama, "Start:", startDate, "End:", endDate, "Today:", today);
        } else {
          // Belum dimulai - default
          rowClass = "row-upcoming";
          console.log("Row upcoming:", row.nama, "Start:", startDate, "Today:", today);
        }
        
        tbody.insertAdjacentHTML("beforeend", `
          <tr data-row="${i}" class="${rowClass}">
            <td>${i+1}</td>
            <td>${row.nama}</td>
            <td>${row.nrp}</td>
            <td>${formatDate(row.tglMulai)}</td>
            <td>${formatDate(row.tglSelesai)}</td>
            <td>${row.lama}</td>
            <td><span class="badge badge-status bg-${badgeClass}">${row.status}</span></td>
            <td>${row.ket}</td>
            <td>
              <button class="btn btn-warning btn-sm edit-btn">‚úèÔ∏è edit</button>
              <button class="btn btn-danger btn-sm delete-btn">üóëÔ∏è hapus</button>
            </td>
          </tr>
        `);
      });
      filterTable();
    }

    // Delegasi tombol edit/hapus
    tbody.addEventListener("click", e=>{
      const tr = e.target.closest("tr");
      if(!tr) return;
      const idx = tr.dataset.row;

      if(e.target.classList.contains("edit-btn")){
        document.getElementById("editIndex").value = idx;
        document.getElementById("editNama").value = tr.children[1].innerText;
        document.getElementById("editNrp").value = tr.children[2].innerText;
        document.getElementById("editMulai").value = tr.children[3].innerText.split("/").reverse().join("-");
        document.getElementById("editSelesai").value = tr.children[4].innerText.split("/").reverse().join("-");
        document.getElementById("editStatus").value = tr.children[6].innerText;
        document.getElementById("editKet").value = tr.children[7].innerText;
        new bootstrap.Modal(document.getElementById("editModal")).show();
      } else if(e.target.classList.contains("delete-btn")){
        if(confirm("Yakin hapus data ini?")){
          fetch(API_URL, {
            method:"POST",
            body: JSON.stringify({action:"delete", row:parseInt(idx)+1, target: "roster"})
          }).then(()=> loadData());
        }
      }
    });

    // Tambah data
    addForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const nama = document.getElementById("nama").value;
      const nrp = document.getElementById("nrp").value;
      const tglMulai = document.getElementById("tglMulai").value;
      const tglSelesai = document.getElementById("tglSelesai").value;
      const status = document.getElementById("status").value;
      const ket = document.getElementById("keterangan").value;
      const lama = ((new Date(tglSelesai)-new Date(tglMulai))/(1000*3600*24))+1;

      await fetch(API_URL, {
        method:"POST",
        body: JSON.stringify({action:"add", nama, nrp, tglMulai, tglSelesai, lama, status, ket, target: "roster"})
      });
      bootstrap.Modal.getInstance(document.getElementById("addModal")).hide();
      addForm.reset();
      loadData();
    });

    // Edit data
    editForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const idx = document.getElementById("editIndex").value;
      const nama = document.getElementById("editNama").value;
      const nrp = document.getElementById("editNrp").value;
      const tglMulai = document.getElementById("editMulai").value;
      const tglSelesai = document.getElementById("editSelesai").value;
      const status = document.getElementById("editStatus").value;
      const ket = document.getElementById("editKet").value;
      const lama = ((new Date(tglSelesai)-new Date(tglMulai))/(1000*3600*24))+1;

      await fetch(API_URL, {
        method:"POST",
        body: JSON.stringify({action:"edit", row:parseInt(idx)+1, nama, nrp, tglMulai, tglSelesai, lama, status, ket, target: "roster"})
      });
      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
      loadData();
    });

    // ====== FUNGSI FILTER ======
    function filterTable(){
      const searchValue = document.getElementById("searchInput").value.toLowerCase();
      const bulanValue = document.getElementById("bulanFilter").value;
      const statusValue = document.getElementById("statusFilter").value;
      let visibleCount = 0;

      const rows = tbody.querySelectorAll("tr");
      rows.forEach(row=>{
        const nama = row.children[1].innerText.toLowerCase();
        const nrp = row.children[2].innerText.toLowerCase();
        const ket = row.children[7].innerText.toLowerCase();
        const status = row.children[6].innerText;
        const bulanMulai = row.children[3].innerText.split("/")[1];

        const matchSearch = nama.includes(searchValue) || nrp.includes(searchValue) || ket.includes(searchValue);
        const matchStatus = statusValue==="" || status===statusValue;
        const matchBulan = bulanValue==="" || bulanMulai===bulanValue;

        if(matchSearch && matchStatus && matchBulan){
          row.style.display = "";
          visibleCount++;
        } else {
          row.style.display = "none";
        }
      });

      const info = document.getElementById("resultInfo");
      if(visibleCount===rows.length){
        info.textContent = "Menampilkan semua data";
      } else {
        info.textContent = `Menampilkan ${visibleCount} data dari total ${rows.length}`;
      }
    }

    document.getElementById("searchInput").addEventListener("input", filterTable);
    document.getElementById("bulanFilter").addEventListener("change", filterTable);
    document.getElementById("statusFilter").addEventListener("change", filterTable);
    document.getElementById("resetBtn").addEventListener("click", ()=>{
      document.getElementById("searchInput").value = "";
      document.getElementById("bulanFilter").value = "";
      document.getElementById("statusFilter").value = "";
      filterTable();
    });

    loadData();

    // Cek login, redirect jika belum login
const user = JSON.parse(localStorage.getItem('bukuSakuUser') || '{}');
if (!user.username) {
  window.location.href = "login.html";
}
  </script>
</body>
</html>