<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prosedur Kerja</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#fda085">
  <style>
    body {
      background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
      min-height: 100vh;
    }
    .prosedur-container {
      max-width: 900px;
      margin: 10px auto;
      padding: 32px 28px 24px 28px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      position: relative;
      overflow: hidden;
    }
    .prosedur-header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 18px;
      gap: 12px;
    }
    .avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fda085 60%, #f6d365 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      color: #fff;
      box-shadow: 0 2px 8px rgba(253,160,133,0.18);
    }
    .prosedur-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #f76b1c;
      letter-spacing: 1px;
    }
    .controls .form-control, .controls .form-select {
      height: 48px;
      border-radius: 8px;
      border: 1px solid #fda08544;
    }
    .table thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
      text-align: center;
    }
    .table-bordered > :not(caption) > * > * {
      border-color: #fda08555;
    }
    .table-hover tbody tr:hover {
      background: linear-gradient(90deg, #fda08522 0%, #f6d36522 100%);
      transition: background 0.18s;
    }
    .list-group-item {
      font-size: 1.08rem;
      font-weight: 500;
      border: none;
      border-radius: 8px !important;
      margin-bottom: 10px;
      background: #f8f9fa;
      color: #f76b1c;
      box-shadow: 0 2px 8px rgba(253,160,133,0.06);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .btn-primary, .btn-success, .btn-warning, .btn-danger {
      border: none;
      font-weight: 600;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(253,160,133,0.13);
      transition: background 0.18s, box-shadow 0.18s;
    }
    .btn-primary {
      background: #fff;
      color: #0d6efd;
      border: 1px solid #0d6efd;
    }
    .btn-primary:hover {
      background: #0d6efd;
      color: #fff;
      border: 1px solid #0d6efd;
    }
    .btn-outline-secondary, .btn-outline-primary {
      border-radius: 8px;
    }
    /* Ensure sync and add buttons have same size */
    #syncBtn, .btn[data-bs-target="#addModal"] {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 1.1rem;
    }
    .offcanvas {
      background: transparent;
      border: none;
      box-shadow: none;
      width: 90px !important;
    }
    .offcanvas-header {
      display: none;
    }
    .offcanvas-title {
      color: #f76b1c;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .nav-link {
      font-weight: 500;
      color: #f76b1c;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      width: 50px;
      height: 50px;
      margin: 0 auto;
    }
    .nav-link:hover, .nav-link.active {
      background: linear-gradient(90deg, #fda08522 0%, #f6d36522 100%);
      color: #f76b1c;
    }
    .btn-menu {
      margin-bottom: 8px;
    }
    @media (max-width: 900px) {
      .prosedur-container {
        padding: 18px 6px 16px 6px;
        max-width: 90vw;
      }
      .prosedur-header {
        flex-direction: column;
        gap: 8px;
        align-items: center;
        justify-content: center;
      }
      .prosedur-title {
        text-align: center;
        width: 100%;
      }
      .avatar {
        margin-right: 0;
        margin-bottom: 6px;
      }
      .offcanvas.offcanvas-start{
        width: 82%;
        max-width: 360px;
        left: 0;
        top: 0;
        height: 100%;
        box-shadow: 2px 8px 40px rgba(0,0,0,0.12);
        border-top-right-radius: 18px;
        border-bottom-right-radius: 18px;
        font-size: 1.4rem;
      }
      .offcanvas-backdrop {
        background-color: rgba(0,0,0,0.35);
      }
      .list-group-item {
        font-size: 1.4rem;
      }
      .btn-group .btn-sm {
        font-size: 0.7rem;
        padding: 0.25rem 0.4rem;
      }
    }
  </style>
</head>
<body>
  <!-- Tombol buka sidebar -->
  <button class="btn btn-outline-secondary btn-menu" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
  ☰
</button>

  <!-- Sidebar Offcanvas -->
  <nav class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">📚 Buku Saku</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body px-1">
      <ul class="nav flex-column">
        <li class="nav-item mb-2"><a class="nav-link" href="dashboard.html">🏠</a></li>
        <li class="nav-item mb-2"><a class="nav-link active" href="prosedur2.html">📑</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="rostercuti2.html">🗓️</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="administrasi.html">🗂️</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="preposttest.html">📝</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="timeframe.html">🕒</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="progress-table.html">⏰</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="daily.html">📘</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="catatan.html">📋</a></li>
        <li class="nav-item mt-4"><a class="nav-link text-danger" href="index.html">🚪</a></li>
      </ul>
    </div>
  </nav>

  <div class="prosedur-container">
    <div class="prosedur-header">
      <div class="avatar">📑</div>
      <div class="prosedur-title">PROSEDUR KERJA</div>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <div class="d-flex gap-2 align-items-center" style="display: none !important;">
        <span id="cacheStatus" class="badge bg-secondary">Memuat...</span>
        <small class="text-muted"></small>
      </div>
      <div class="d-flex gap-2">
        <button id="syncBtn" class="btn btn-outline-primary btn-sm" onclick="manualSync()">🔄</button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">➕</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="row g-2 controls mb-3">
      <div class="col-12 col-md-6">
        <input id="searchInput" class="form-control" type="text" placeholder="🔍 Cari STD / INK / keterangan…">
      </div>
      <div class="col-6 col-md-3">
        <select id="statusFilter" class="form-select">
          <option value="">Filter Prosedur (Semua)</option>
          <option value="SOP">SOP</option>
          <option value="STD">STD</option>
          <option value="INK">INK</option>
          <option value="JSA">JSA</option>
        </select>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <small class="text-muted" id="resultInfo">Menampilkan semua file</small>
      <div class="btn-group">
        <button id="resetBtn" class="btn btn-outline-secondary btn-sm">Reset</button>
        <button onclick="clearAllCache()" class="btn btn-outline-warning btn-sm">Clear Cache</button>
        <button onclick="window.print()" class="btn btn-outline-primary btn-sm">Print</button>
      </div>
    </div>

    <!-- Tabel -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle" id="cutiTable">
        <thead>
          <tr>
            <th style="min-width:20px;">No</th>
            <th style="min-width:320px;">Nama file</th>
            <th style="min-width:80px;">URL</th>
            <th style="min-width:100px;">Jenis File</th>
            <th style="min-width:100px;">Keterangan</th>
            <th style="min-width:150px;">Aksi</th>
          </tr>
        </thead>
        <tbody id="cutiBody">
          <!-- Data diisi oleh JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal Tambah -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addForm">
          <div class="modal-header">
            <h5 class="modal-title">Tambah Prosedur</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" class="form-control mb-2" id="namaFile" placeholder="Nama File" required>
            <input type="text" class="form-control mb-2" id="url" placeholder="URL google drive" required>
            <select class="form-select mb-2" id="jenis" required>
              <option value="">Jenis Prosedur</option>
              <option value="SOP">SOP</option>
              <option value="STD">STD</option>
              <option value="INK">INK</option>
              <option value="JSA">JSA</option>
            </select>
            <input type="text" class="form-control mb-2" id="keterangan" placeholder="Keterangan" required>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button class="btn btn-success" type="submit">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Edit -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editForm">
          <div class="modal-header">
            <h5 class="modal-title">Edit Data File</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editIndex">
            <input type="text" class="form-control mb-2" id="editNamaFile" required>
            <input type="text" class="form-control mb-2" id="editUrl" required>
            <select class="form-select mb-2" id="editJenis" required>
              <option value="SOP">SOP</option>
              <option value="STD">STD</option>
              <option value="INK">INK</option>
              <option value="JSA">JSA</option>
            </select>
            <input type="text" class="form-control mb-2" id="editKet" required>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button class="btn btn-success" type="submit">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- User Utils -->
  <script src="user-utils.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  
  <script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyCCBwvqjaG_M0a7308ZfDDJb7Mm3LjHxeI", 
  authDomain: "buku-saku-instruktur.firebaseapp.com",
  projectId: "buku-saku-instruktur",
  storageBucket: "buku-saku-instruktur.firebasestorage.app",
  messagingSenderId: "180222950163",
  appId: "1:180222950163:web:3331e9673249098aa038e6"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const API_URL = "https://script.google.com/macros/s/AKfycbyCbEPQIcaKgBU-jQbmSeC_1R1tXh1Y3hA7d3q8VMCr46qtpm6lanKbrebZ-1OD2Q7h/exec";   
const tbody = document.getElementById("cutiBody");
const addForm = document.getElementById("addForm");
const editForm = document.getElementById("editForm");

const CACHE_KEY = 'prosedur_cache_data';
const CACHE_TIMESTAMP_KEY = 'prosedur_cache_timestamp';
const CACHE_DURATION = 6 * 60 * 60 * 1000; // 6 hours in milliseconds

let currentData = [];

// Utility functions
function showLoading(message = "Memuat data...") {
  tbody.innerHTML = `<tr><td colspan="6" class="text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div> ${message}
  </td></tr>`;
}

function showError(message) {
  tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">⚠️ ${message}</td></tr>`;
}

function updateCacheStatus(status, isOld = false) {
  const statusElement = document.getElementById('cacheStatus');
  if (statusElement) {
    statusElement.textContent = status;
    statusElement.className = isOld ? 'badge bg-warning' : 'badge bg-success';
  }
}

// Cache management
function saveToLocalCache(data) {
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
    localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
    console.log('Data saved to local cache');
  } catch (error) {
    console.error('Error saving to local cache:', error);
  }
}

function getFromLocalCache() {
  try {
    const data = localStorage.getItem(CACHE_KEY);
    const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
    
    if (!data || !timestamp) return null;
    
    const age = Date.now() - parseInt(timestamp);
    if (age > CACHE_DURATION) {
      console.log('Local cache expired');
      return null;
    }
    
    console.log('Data loaded from local cache');
    return JSON.parse(data);
  } catch (error) {
    console.error('Error reading from local cache:', error);
    return null;
  }
}

function isCacheOld() {
  const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
  if (!timestamp) return true;
  
  const age = Date.now() - parseInt(timestamp);
  return age > CACHE_DURATION;
}

// Firebase cache functions
async function saveToFirebaseCache(data) {
  try {
    // Clear existing cache
    const querySnapshot = await db.collection('prosedur_cache').get();
    const batch = db.batch();
    querySnapshot.docs.forEach((doc) => {
      batch.delete(doc.ref);
    });
    await batch.commit();
    
    // Save new data
    const newBatch = db.batch();
    data.forEach((item, index) => {
      const docRef = db.collection('prosedur_cache').doc();
      newBatch.set(docRef, {
        ...item,
        order: index,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await newBatch.commit();
    console.log('Data synced to Firebase cache');
  } catch (error) {
    console.error('Error saving to Firebase cache:', error);
  }
}

async function getFromFirebaseCache() {
  try {
    const querySnapshot = await db.collection('prosedur_cache')
      .orderBy('order')
      .get();
    
    const data = [];
    querySnapshot.forEach((doc) => {
      const docData = doc.data();
      data.push({
        namaFile: docData.namaFile,
        url: docData.url,
        jenis: docData.jenis,
        keterangan: docData.keterangan
      });
    });
    
    if (data.length > 0) {
      console.log('Data loaded from Firebase cache');
      return data;
    }
    return null;
  } catch (error) {
    console.error('Error getting from Firebase cache:', error);
    return null;
  }
}

// Render data to table
function renderData(data) {
  currentData = data;
  tbody.innerHTML = "";
  
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Tidak ada data prosedur</td></tr>';
    return;
  }
  
  data.forEach((row, i) => {
    tbody.insertAdjacentHTML("beforeend", `
      <tr data-row="${i}">
        <td>${i+1}</td>
        <td>${row.namaFile}</td>
        <td><a href="${row.url}" target="_blank">BACA</a></td>
        <td>${row.jenis}</td>
        <td>${row.keterangan}</td>
        <td>
          <button class="btn btn-warning btn-sm edit-btn">✏️</button>
          <button class="btn btn-danger btn-sm delete-btn">🗑️</button>
        </td>
      </tr>
    `);
  });
  
  updateResultInfo();
}

// Load data with multiple fallback strategies
async function loadData(forceRefresh = false) {
  try {
    showLoading();
    
    let data = null;
    let cacheUsed = '';
    
    // 1. Try local cache first (if not forcing refresh)
    if (!forceRefresh) {
      data = getFromLocalCache();
      if (data) {
        cacheUsed = 'Local Cache';
        updateCacheStatus(cacheUsed, isCacheOld());
        renderData(data);
        
        // If cache is old, try to refresh in background
        if (isCacheOld()) {
          loadDataFromSource(true); // Background refresh
        }
        return;
      }
    }
    
    // 2. Try Firebase cache
    if (!data) {
      showLoading("Mencoba Firebase cache...");
      data = await getFromFirebaseCache();
      if (data) {
        cacheUsed = 'Firebase Cache';
        updateCacheStatus(cacheUsed, false);
        renderData(data);
        saveToLocalCache(data); // Save to local cache for faster next load
        return;
      }
    }
    
    // 3. Load from Google Sheets as last resort
    await loadDataFromSource();
    
  } catch (error) {
    console.error('Error in loadData:', error);
    showError('Gagal memuat data. Silakan refresh halaman.');
  }
}

// Load data directly from Google Sheets
async function loadDataFromSource(isBackground = false) {
  try {
    if (!isBackground) {
      showLoading("Memuat dari Google Sheets...");
    }
    
    const response = await fetch(API_URL + "?action=files");
    if (!response.ok) {
      throw new Error('Failed to fetch from Google Sheets');
    }
    
    const data = await response.json();
    
    if (!isBackground) {
      renderData(data);
      updateCacheStatus('Google Sheets (Live)', false);
    }
    
    // Save to both caches
    saveToLocalCache(data);
    await saveToFirebaseCache(data);
    
    console.log('Data loaded from Google Sheets and cached');
    return data;
    
  } catch (error) {
    console.error('Error loading from source:', error);
    if (!isBackground) {
      showError('Gagal memuat data dari Google Sheets');
    }
    throw error;
  }
}

// Delegasi tombol edit/hapus
tbody.addEventListener("click", async e => {
  const tr = e.target.closest("tr");
  if(!tr) return;
  const idx = parseInt(tr.dataset.row);

  if(e.target.classList.contains("edit-btn")){
    const rowData = currentData[idx];
    if (!rowData) return;
    
    document.getElementById("editIndex").value = idx;
    document.getElementById("editNamaFile").value = rowData.namaFile;
    document.getElementById("editUrl").value = rowData.url;
    document.getElementById("editJenis").value = rowData.jenis;
    document.getElementById("editKet").value = rowData.keterangan;
    new bootstrap.Modal(document.getElementById("editModal")).show();
  } 
  else if(e.target.classList.contains("delete-btn")){
    if(confirm("Yakin hapus data ini?")){
      try {
        const response = await fetch(API_URL, {
          method:"POST",
          body: JSON.stringify({action:"delete", row:idx+2, target: "file"})
        });
        
        if (response.ok) {
          await loadDataFromSource(); // Force refresh from source
        } else {
          alert('Gagal menghapus data');
        }
      } catch (error) {
        console.error('Error deleting:', error);
        alert('Terjadi kesalahan saat menghapus data');
      }
    }
  }
});

// Tambah data
addForm.addEventListener("submit", async e => {
  e.preventDefault();
  
  try {
    const namaFile = document.getElementById("namaFile").value;
    const url = document.getElementById("url").value;
    const jenis = document.getElementById("jenis").value;
    const keterangan = document.getElementById("keterangan").value;

    const response = await fetch(API_URL, {
      method:"POST",
      body: JSON.stringify({action:"add", namaFile, url, jenis, keterangan, target: "file"})
    });

    if (response.ok) {
      bootstrap.Modal.getInstance(document.getElementById("addModal")).hide();
      addForm.reset();
      await loadDataFromSource(); // Force refresh from source
    } else {
      alert('Gagal menambah data');
    }
  } catch (error) {
    console.error('Error adding:', error);
    alert('Terjadi kesalahan saat menambah data');
  }
});

// Edit data
editForm.addEventListener("submit", async e => {
  e.preventDefault();
  
  try {
    const idx = parseInt(document.getElementById("editIndex").value);
    const namaFile = document.getElementById("editNamaFile").value;
    const url = document.getElementById("editUrl").value;
    const jenis = document.getElementById("editJenis").value;
    const keterangan = document.getElementById("editKet").value;

    const response = await fetch(API_URL, {
      method:"POST",
      body: JSON.stringify({action:"edit", row:idx+2, namaFile, url, jenis, keterangan, target: "file"})
    });

    if (response.ok) {
      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
      await loadDataFromSource(); // Force refresh from source
    } else {
      alert('Gagal mengupdate data');
    }
  } catch (error) {
    console.error('Error updating:', error);
    alert('Terjadi kesalahan saat mengupdate data');
  }
});

// Update result info
function updateResultInfo() {
  const info = document.getElementById("resultInfo");
  const rows = tbody.querySelectorAll("tr:not([style*='display: none'])");
  const totalRows = currentData.length;
  const visibleRows = rows.length;
  
  if (visibleRows === totalRows) {
    info.textContent = `Menampilkan semua ${totalRows} file`;
  } else {
    info.textContent = `Menampilkan ${visibleRows} file dari total ${totalRows}`;
  }
}

// Fungsi filter tabel
function filterTable() {
  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  const statusValue = document.getElementById("statusFilter").value;

  const rows = tbody.querySelectorAll("tr");
  rows.forEach(row => {
    if (row.children.length < 6) return; // Skip loading/error rows
    
    const namaFile = row.children[1].innerText.toLowerCase();
    const url = row.children[2].innerText.toLowerCase();
    const jenis = row.children[3].innerText.toLowerCase();
    const ket = row.children[4].innerText.toLowerCase();

    const matchSearch = namaFile.includes(searchValue) || url.includes(searchValue) || ket.includes(searchValue);
    const matchStatus = statusValue === "" || jenis === statusValue.toLowerCase();

    if (matchSearch && matchStatus) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });

  updateResultInfo();
}

// Manual sync function
async function manualSync() {
  try {
    const syncBtn = document.getElementById('syncBtn');
    if (syncBtn) {
      syncBtn.disabled = true;
      syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Sync...';
    }
    
    await loadDataFromSource();
    
    if (syncBtn) {
      syncBtn.disabled = false;
      syncBtn.innerHTML = '🔄 Sync Manual';
    }
    
    alert('Sinkronisasi berhasil!');
  } catch (error) {
    console.error('Manual sync error:', error);
    alert('Gagal melakukan sinkronisasi');
    
    const syncBtn = document.getElementById('syncBtn');
    if (syncBtn) {
      syncBtn.disabled = false;
      syncBtn.innerHTML = '🔄 Sync Manual';
    }
  }
}

// Clear cache function
function clearAllCache() {
  if (confirm('Yakin ingin menghapus semua cache? Data akan dimuat ulang dari Google Sheets.')) {
    try {
      // Clear local storage
      localStorage.removeItem(CACHE_KEY);
      localStorage.removeItem(CACHE_TIMESTAMP_KEY);
      
      // Clear Firebase cache
      db.collection('prosedur_cache').get().then(querySnapshot => {
        const batch = db.batch();
        querySnapshot.docs.forEach((doc) => {
          batch.delete(doc.ref);
        });
        return batch.commit();
      }).then(() => {
        console.log('Firebase cache cleared');
      }).catch(error => {
        console.error('Error clearing Firebase cache:', error);
      });
      
      // Reload data
      loadDataFromSource();
      alert('Cache berhasil dihapus!');
    } catch (error) {
      console.error('Error clearing cache:', error);
      alert('Gagal menghapus cache');
    }
  }
}

// Event listeners
document.getElementById("searchInput").addEventListener("input", filterTable);
document.getElementById("statusFilter").addEventListener("change", filterTable);
document.getElementById("resetBtn").addEventListener("click", () => {
  document.getElementById("searchInput").value = "";
  document.getElementById("statusFilter").value = "";
  filterTable();
});

// Expose functions globally
window.manualSync = manualSync;
window.clearAllCache = clearAllCache;

// Initialize - load data on page load
loadData();

// Check authentication using utility
userUtils.requireAuth('index.html');
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>
</body>
</html>