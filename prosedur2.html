<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prosedur Kerja</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#fda085">
  <style>
    body {
      background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
      min-height: 100vh;
    }
    .prosedur-container {
      max-width: 900px;
      margin: 10px auto;
      padding: 32px 28px 24px 28px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      position: relative;
      overflow: hidden;
    }
    .prosedur-header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 18px;
      gap: 12px;
    }
    .avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fda085 60%, #f6d365 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      color: #fff;
      box-shadow: 0 2px 8px rgba(253,160,133,0.18);
    }
    .prosedur-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #f76b1c;
      letter-spacing: 1px;
    }
    .controls .form-control, .controls .form-select {
      height: 48px;
      border-radius: 8px;
      border: 1px solid #fda08544;
    }
    .table thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
      text-align: center;
    }
    .table-bordered > :not(caption) > * > * {
      border-color: #fda08555;
    }
    .table-hover tbody tr:hover {
      background: linear-gradient(90deg, #fda08522 0%, #f6d36522 100%);
      transition: background 0.18s;
    }
    .list-group-item {
      font-size: 1.08rem;
      font-weight: 500;
      border: none;
      border-radius: 8px !important;
      margin-bottom: 10px;
      background: #f8f9fa;
      color: #f76b1c;
      box-shadow: 0 2px 8px rgba(253,160,133,0.06);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .btn-primary, .btn-success, .btn-warning, .btn-danger, .btn-back {
      border: none;
      font-weight: 600;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(253,160,133,0.13);
      transition: background 0.18s, box-shadow 0.18s;
    }
    .btn-primary {
      background: linear-gradient(90deg, #f76b1c 60%, #fda085 100%);
      color: #fff;
    }
    .btn-primary:hover {
      background: linear-gradient(90deg, #fda085 0%, #f76b1c 100%);
      color: #fff;
    }
    .btn-back {
      background: linear-gradient(90deg, #f76b1c 60%, #fda085 100%);
      color: #fff;
      margin-top: 18px;
      padding: 10px 36px;
    }
    .btn-back:hover {
      background: linear-gradient(90deg, #fda085 0%, #f76b1c 100%);
      color: #fff;
    }
    .btn-outline-secondary, .btn-outline-primary {
      border-radius: 8px;
    }
    .offcanvas {
      background: #fff8f3;
      border-top-right-radius: 18px;
      border-bottom-right-radius: 18px;
      box-shadow: 2px 0 16px rgba(253,160,133,0.08);
    }
    .offcanvas-title {
      color: #f76b1c;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .nav-link {
      font-weight: 500;
      color: #f76b1c;
      border-radius: 8px;
    }
    .nav-link:hover, .nav-link.active {
      background: linear-gradient(90deg, #fda08522 0%, #f6d36522 100%);
      color: #f76b1c;
    }
    .btn-menu {
      margin-bottom: 8px;
    }
    @media (max-width: 900px) {
      .prosedur-container {
        padding: 18px 6px 16px 6px;
        max-width: 90vw;
      }
      .prosedur-header {
        flex-direction: column;
        gap: 8px;
        align-items: center;
        justify-content: center;
      }
      .prosedur-title {
        text-align: center;
        width: 100%;
      }
      .avatar {
        margin-right: 0;
        margin-bottom: 6px;
      }
      .offcanvas.offcanvas-start{
        width: 82%;
        max-width: 360px;
        left: 0;
        top: 0;
        height: 100%;
        box-shadow: 2px 8px 40px rgba(0,0,0,0.12);
        border-top-right-radius: 18px;
        border-bottom-right-radius: 18px;
        font-size: 1.4rem;
      }
      .offcanvas-backdrop {
        background-color: rgba(0,0,0,0.35);
      }
      .list-group-item {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <!-- Tombol buka sidebar -->
  <button class="btn btn-outline-secondary btn-menu" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
  ‚ò∞ Menu
</button>

  <!-- Sidebar Offcanvas -->
  <nav class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">üìö Buku Saku</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body px-2">
      <ul class="nav flex-column">
        <li class="nav-item mb-2"><a class="nav-link" href="dashboard.html">üè† Dashboard</a></li>
        <li class="nav-item mb-2"><a class="nav-link active" href="prosedur2.html">üìë Prosedur</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="rostercuti2.html">üóìÔ∏è Roster Cuti</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="administrasi.html">üóÇÔ∏è Administrasi</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="preposttest.html">üìù Pre/Post Test</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="timeframe.html">üïí Jadwal Pelatihan</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="progress-table.html">‚è∞ Update HM</a></li>
        <li class="nav-item mb-2"><a class="nav-link" href="daily.html">üìò Daily Activity</a></li>
        <li class="nav-item mt-4"><a class="nav-link text-danger" href="index.html">üö™ Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="prosedur-container">
    <div class="prosedur-header">
      <div class="avatar">üìë</div>
      <div class="prosedur-title">PROSEDUR KERJA</div>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <div></div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">‚ûï Tambah File</button>
    </div>

    <!-- Controls -->
    <div class="row g-2 controls mb-3">
      <div class="col-12 col-md-6">
        <input id="searchInput" class="form-control" type="text" placeholder="üîç Cari STD / INK / keterangan‚Ä¶">
      </div>
      <div class="col-6 col-md-3">
        <select id="statusFilter" class="form-select">
          <option value="">Filter Prosedur (Semua)</option>
          <option value="SOP">SOP</option>
          <option value="STD">STD</option>
          <option value="INK">INK</option>
          <option value="JSA">JSA</option>
        </select>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <small class="text-muted" id="resultInfo">Menampilkan semua file</small>
      <div class="btn-group">
        <button id="resetBtn" class="btn btn-outline-secondary btn-sm">Reset</button>
        <button onclick="window.print()" class="btn btn-outline-primary btn-sm">Print</button>
      </div>
    </div>

    <!-- Tabel -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle" id="cutiTable">
        <thead>
          <tr>
            <th style="min-width:20px;">No</th>
            <th style="min-width:320px;">Nama file</th>
            <th style="min-width:80px;">URL</th>
            <th style="min-width:100px;">Jenis File</th>
            <th style="min-width:100px;">Keterangan</th>
            <th style="min-width:150px;">Aksi</th>
          </tr>
        </thead>
        <tbody id="cutiBody">
          <!-- Data diisi oleh JS -->
        </tbody>
      </table>
    </div>
    <div class="text-center mt-4">
      <a href="dashboard.html" class="btn btn-back">‚¨ÖÔ∏è Kembali ke Dashboard</a>
    </div>
  </div>

  <!-- Modal Tambah -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addForm">
          <div class="modal-header">
            <h5 class="modal-title">Tambah Prosedur</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" class="form-control mb-2" id="namaFile" placeholder="Nama File" required>
            <input type="text" class="form-control mb-2" id="url" placeholder="URL google drive" required>
            <select class="form-select mb-2" id="jenis" required>
              <option value="">Jenis Prosedur</option>
              <option value="SOP">SOP</option>
              <option value="STD">STD</option>
              <option value="INK">INK</option>
              <option value="JSA">JSA</option>
            </select>
            <input type="text" class="form-control mb-2" id="keterangan" placeholder="Keterangan" required>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button class="btn btn-success" type="submit">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Edit -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editForm">
          <div class="modal-header">
            <h5 class="modal-title">Edit Data File</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editIndex">
            <input type="text" class="form-control mb-2" id="editNamaFile" required>
            <input type="text" class="form-control mb-2" id="editUrl" required>
            <select class="form-select mb-2" id="editJenis" required>
              <option value="SOP">SOP</option>
              <option value="STD">STD</option>
              <option value="INK">INK</option>
              <option value="JSA">JSA</option>
            </select>
            <input type="text" class="form-control mb-2" id="editKet" required>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button class="btn btn-success" type="submit">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Authentication Script with Fallback -->
  <script src="auth-helper-simple.js"></script>

  <!-- Main Application Script -->
  <script type="module">
// Import Firebase functions for prosedur management
import { 
  getProsedurFiles, 
  addProsedurFile, 
  updateProsedurFile, 
  deleteProsedurFile,
  searchProsedurFiles 
} from './prosedur-firebase.js';

const tbody = document.getElementById("cutiBody");
const addForm = document.getElementById("addForm");
const editForm = document.getElementById("editForm");

// Load data from Firebase instead of Google Sheets
async function loadData() {
  try {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';
    
    const files = await getProsedurFiles();
    tbody.innerHTML = "";
    
    if (files.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Belum ada data prosedur</td></tr>';
      return;
    }
    
    files.forEach((file, i) => {
      tbody.insertAdjacentHTML("beforeend", `
        <tr data-id="${file.id}">
          <td>${i+1}</td>
          <td>${file.namaFile}</td>
          <td><a href="${file.url}" target="_blank" class="btn btn-sm btn-outline-primary">üìñ BACA</a></td>
          <td><span class="badge bg-secondary">${file.jenis}</span></td>
          <td>${file.keterangan}</td>
          <td>
            <button class="btn btn-warning btn-sm edit-btn" data-id="${file.id}">‚úèÔ∏è edit</button>
            <button class="btn btn-danger btn-sm delete-btn" data-id="${file.id}">üóëÔ∏è hapus</button>
          </td>
        </tr>
      `);
    });
    
    updateResultInfo(files.length, files.length);
  } catch (error) {
    console.error('Error loading data:', error);
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
  }
}

// Event handler for edit/delete buttons
tbody.addEventListener("click", async (e) => {
  const tr = e.target.closest("tr");
  if (!tr || !tr.dataset.id) return;
  
  const fileId = tr.dataset.id;
  
  if (e.target.classList.contains("edit-btn")) {
    // Edit button clicked
    document.getElementById("editIndex").value = fileId;
    document.getElementById("editNamaFile").value = tr.children[1].innerText;
    document.getElementById("editUrl").value = tr.children[2].querySelector("a").href;
    document.getElementById("editJenis").value = tr.children[3].querySelector("span").innerText;
    document.getElementById("editKet").value = tr.children[4].innerText;
    new bootstrap.Modal(document.getElementById("editModal")).show();
  } 
  else if (e.target.classList.contains("delete-btn")) {
    // Delete button clicked
    if (confirm("Yakin hapus data prosedur ini?")) {
      try {
        e.target.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        e.target.disabled = true;
        
        await deleteProsedurFile(fileId);
        await loadData(); // Reload data
        
        alert("Data berhasil dihapus!");
      } catch (error) {
        console.error('Error deleting file:', error);
        alert("Error menghapus data: " + error.message);
        e.target.innerHTML = 'üóëÔ∏è hapus';
        e.target.disabled = false;
      }
    }
  }
});

// Add new prosedur file
addForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const namaFile = document.getElementById("namaFile").value.trim();
  const url = document.getElementById("url").value.trim();
  const jenis = document.getElementById("jenis").value;
  const keterangan = document.getElementById("keterangan").value.trim();
  
  if (!namaFile || !url || !jenis || !keterangan) {
    alert("Semua field harus diisi!");
    return;
  }
  
  const submitBtn = addForm.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  try {
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...';
    submitBtn.disabled = true;
    
    await addProsedurFile({
      namaFile,
      url,
      jenis,
      keterangan
    });
    
    bootstrap.Modal.getInstance(document.getElementById("addModal")).hide();
    addForm.reset();
    await loadData(); // Reload data
    
    alert("Data prosedur berhasil ditambahkan!");
  } catch (error) {
    console.error('Error adding file:', error);
    alert("Error menambah data: " + error.message);
  } finally {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
});

// Edit prosedur file
editForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const fileId = document.getElementById("editIndex").value;
  const namaFile = document.getElementById("editNamaFile").value.trim();
  const url = document.getElementById("editUrl").value.trim();
  const jenis = document.getElementById("editJenis").value;
  const keterangan = document.getElementById("editKet").value.trim();
  
  if (!namaFile || !url || !jenis || !keterangan) {
    alert("Semua field harus diisi!");
    return;
  }
  
  const submitBtn = editForm.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  try {
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
    submitBtn.disabled = true;
    
    await updateProsedurFile(fileId, {
      namaFile,
      url,
      jenis,
      keterangan
    });
    
    bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
    await loadData(); // Reload data
    
    alert("Data prosedur berhasil diupdate!");
  } catch (error) {
    console.error('Error updating file:', error);
    alert("Error mengupdate data: " + error.message);
  } finally {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
});

// Initial load
loadData();

// Update result info helper function
function updateResultInfo(visibleCount, totalCount) {
  const info = document.getElementById("resultInfo");
  if (visibleCount === totalCount) {
    info.textContent = `Menampilkan semua ${totalCount} file`;
  } else {
    info.textContent = `Menampilkan ${visibleCount} file dari total ${totalCount}`;
  }
}

// Filter function using Firebase search
async function filterTable() {
  const searchValue = document.getElementById("searchInput").value.toLowerCase().trim();
  const statusValue = document.getElementById("statusFilter").value;
  
  try {
    const filteredFiles = await searchProsedurFiles(searchValue, statusValue);
    const allFiles = await getProsedurFiles();
    
    tbody.innerHTML = "";
    
    if (filteredFiles.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Tidak ada data yang cocok dengan filter</td></tr>';
      updateResultInfo(0, allFiles.length);
      return;
    }
    
    filteredFiles.forEach((file, i) => {
      tbody.insertAdjacentHTML("beforeend", `
        <tr data-id="${file.id}">
          <td>${i+1}</td>
          <td>${file.namaFile}</td>
          <td><a href="${file.url}" target="_blank" class="btn btn-sm btn-outline-primary">üìñ BACA</a></td>
          <td><span class="badge bg-secondary">${file.jenis}</span></td>
          <td>${file.keterangan}</td>
          <td>
            <button class="btn btn-warning btn-sm edit-btn" data-id="${file.id}">‚úèÔ∏è edit</button>
            <button class="btn btn-danger btn-sm delete-btn" data-id="${file.id}">üóëÔ∏è hapus</button>
          </td>
        </tr>
      `);
    });
    
    updateResultInfo(filteredFiles.length, allFiles.length);
  } catch (error) {
    console.error('Error filtering data:', error);
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error filtering data</td></tr>';
  }
}

// Event listeners for search and filter
document.getElementById("searchInput").addEventListener("input", filterTable);
document.getElementById("statusFilter").addEventListener("change", filterTable);
document.getElementById("resetBtn").addEventListener("click", async () => {
  document.getElementById("searchInput").value = "";
  document.getElementById("statusFilter").value = "";
  await loadData(); // Reload all data
});

  </script>
</body>
</html>
