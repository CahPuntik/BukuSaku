<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase Storage Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üß™ Test Firebase Storage Upload</h5>
                        <small class="text-muted">Bucket: gs://buku-saku-instruktur.firebasestorage.app</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="testFile" class="form-label">Pilih File untuk Test Upload</label>
                            <input type="file" class="form-control" id="testFile" accept=".pdf,.doc,.docx,.xls,.xlsx">
                        </div>
                        <button onclick="testUpload()" class="btn btn-primary" id="uploadBtn">
                            üì§ Test Upload
                        </button>
                        
                        <div id="results" class="mt-3"></div>
                        <div id="progress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDh8YbByLG7AZEaaCgXiWJOK3cuzjxkqog",
            authDomain: "buku-saku-instruktur.firebaseapp.com",
            projectId: "buku-saku-instruktur",
            storageBucket: "buku-saku-instruktur.firebasestorage.app",
            messagingSenderId: "971524107627",
            appId: "1:971524107627:web:89707dc7b42b32e7d1e470"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        window.testUpload = async function() {
            const fileInput = document.getElementById('testFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const results = document.getElementById('results');
            const progress = document.getElementById('progress');

            if (!fileInput.files[0]) {
                results.innerHTML = '<div class="alert alert-warning">Pilih file terlebih dahulu!</div>';
                return;
            }

            const file = fileInput.files[0];
            const fileName = `test_${Date.now()}_${file.name}`;
            const storageRef = ref(storage, `prosedur_files/${fileName}`);

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
            progress.style.display = 'block';
            results.innerHTML = '';

            try {
                console.log('üöÄ Starting test upload...');
                console.log('üìÅ File:', file.name, 'Size:', file.size, 'Type:', file.type);
                console.log('üéØ Target path:', `gs://buku-saku-instruktur.firebasestorage.app/prosedur_files/${fileName}`);

                // Upload file
                const snapshot = await uploadBytes(storageRef, file);
                console.log('‚úÖ Upload completed:', snapshot);

                // Get download URL
                const downloadURL = await getDownloadURL(snapshot.ref);
                console.log('üîó Download URL:', downloadURL);

                results.innerHTML = `
                    <div class="alert alert-success">
                        <h6>‚úÖ Upload Berhasil!</h6>
                        <p><strong>File:</strong> ${file.name}</p>
                        <p><strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        <p><strong>Storage Path:</strong> prosedur_files/${fileName}</p>
                        <p><strong>Download URL:</strong></p>
                        <a href="${downloadURL}" target="_blank" class="btn btn-sm btn-outline-primary">üì• Download File</a>
                    </div>
                `;

            } catch (error) {
                console.error('‚ùå Upload failed:', error);
                results.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>‚ùå Upload Gagal</h6>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Code:</strong> ${error.code}</p>
                        <details>
                            <summary>Detail Error</summary>
                            <pre>${error.stack}</pre>
                        </details>
                    </div>
                `;
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = 'üì§ Test Upload';
                progress.style.display = 'none';
            }
        };

        // Initialize
        console.log('üîß Firebase Storage initialized');
        console.log('üì¶ Storage bucket:', storage.app.options.storageBucket);
    </script>
</body>
</html>